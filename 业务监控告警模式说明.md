# 业务监控告警模式说明

## 告警模式

业务监控支持两种告警模式，根据阈值设置自动选择：

### 模式1：存在模式（推荐用于异常数据监控）

**触发条件**：只要SQL查询有返回数据就告警

**阈值设置**：0 或 不填写（留空）

**适用场景**：
- 监控不应该存在的数据
- 监控异常状态的记录
- 监控错误日志
- 监控待处理的问题

**示例场景**：

#### 场景1：监控异常产品数据
```
SQL查询: 
  SELECT product_id, product_name, status 
  FROM products 
  WHERE status = 'error'

阈值: 0

含义: 只要有状态为error的产品，就立即告警
```

#### 场景2：监控支付失败
```
SQL查询:
  SELECT payment_id, order_id, fail_reason 
  FROM payments 
  WHERE status = 'failed' 
  AND created_at > NOW() - INTERVAL 1 HOUR

阈值: 0

含义: 只要最近1小时有支付失败，就立即告警
```

#### 场景3：监控系统错误
```
SQL查询:
  SELECT error_type, error_message, created_at 
  FROM error_logs 
  WHERE level = 'critical'

阈值: 0

含义: 只要有严重错误，就立即告警
```

#### 场景4：监控超时订单
```
SQL查询:
  SELECT order_id, customer_name, created_at 
  FROM orders 
  WHERE status = 'pending' 
  AND created_at < NOW() - INTERVAL 2 HOUR

阈值: 0

含义: 只要有超过2小时未处理的订单，就立即告警
```

### 模式2：阈值模式（用于数量监控）

**触发条件**：当数值超过设定的阈值时告警

**阈值设置**：大于0的数字（如：10, 50, 100）

**适用场景**：
- 监控数量是否超标
- 监控积压是否过多
- 监控资源使用情况

**示例场景**：

#### 场景1：监控待处理订单数量
```
SQL查询:
  SELECT COUNT(*) 
  FROM orders 
  WHERE status = 'pending'

阈值: 100

含义: 待处理订单超过100个时告警
```

#### 场景2：监控库存不足商品数量
```
SQL查询:
  SELECT COUNT(*) 
  FROM products 
  WHERE stock < 10

阈值: 5

含义: 低库存商品超过5个时告警
```

#### 场景3：监控错误日志数量
```
SQL查询:
  SELECT COUNT(*) 
  FROM error_logs 
  WHERE created_at > NOW() - INTERVAL 1 HOUR

阈值: 50

含义: 最近1小时错误超过50个时告警
```

## 告警行为对比

### 存在模式（阈值=0）

```
查询返回 0条记录  → 不告警 ✅
查询返回 1条记录  → 告警 ⚠️
查询返回 10条记录 → 告警 ⚠️
查询返回 100条记录 → 告警 ⚠️
```

**特点**：
- 只要有数据就告警
- 适合"不应该存在"的数据
- 零容忍策略

### 阈值模式（阈值>0，如100）

```
查询返回 0条记录   → 不告警 ✅
查询返回 50条记录  → 不告警 ✅
查询返回 100条记录 → 不告警 ✅
查询返回 101条记录 → 告警 ⚠️
查询返回 200条记录 → 告警 ⚠️
```

**特点**：
- 超过阈值才告警
- 适合"数量过多"的监控
- 允许一定范围内的数据

## 实际应用示例

### 示例1：产品明细数据监控（存在模式）

**业务需求**：
- 监控某个特定状态的产品
- 只要有这种状态的产品就需要处理
- 不允许存在这种状态的产品

**配置**：
```
监控目标名称: 业务监控-产品明细数据
SQL查询: 
  SELECT field0007, field0032 
  FROM formmain_1445 
  WHERE field0032 = "2"
阈值: 0
```

**告警行为**：
```
查询结果: 0条  → 正常 ✅ 没有需要处理的产品
查询结果: 1条  → 告警 ⚠️ 发现1个需要处理的产品
查询结果: 18条 → 告警 ⚠️ 发现18个需要处理的产品
```

**告警信息**：
```
业务指标异常: PTF-CARD-HQ2X (共18条记录，显示前10条)
  [1] PTF-CARD-HQ2X, 2
  [2] FW-LIC-H4126-IPS-3Y, 2
  [3] PTF-SSD-960, 2
  ...
  [10] XXX-YYY-ZZZ, 2
  ... 还有 8 条记录
```

### 示例2：待处理订单监控（阈值模式）

**业务需求**：
- 监控待处理订单数量
- 少量订单是正常的
- 超过100个才需要告警

**配置**：
```
监控目标名称: 待处理订单监控
SQL查询:
  SELECT order_id, customer_name, amount, created_at 
  FROM orders 
  WHERE status = 'pending'
阈值: 100
```

**告警行为**：
```
查询结果: 45条  → 正常 ✅ 订单数量在可控范围内
查询结果: 100条 → 正常 ✅ 刚好达到阈值
查询结果: 125条 → 告警 ⚠️ 订单积压过多
```

## 如何选择告警模式

### 使用存在模式（阈值=0）的情况

✅ **应该使用**：
- 监控错误、异常、失败的记录
- 监控不应该存在的状态
- 监控需要立即处理的问题
- 监控超时、过期的数据
- 零容忍的业务规则

❌ **不应该使用**：
- 监控正常业务数据的数量
- 允许一定范围内存在的数据
- 需要达到一定规模才处理的情况

### 使用阈值模式（阈值>0）的情况

✅ **应该使用**：
- 监控数量是否超标
- 监控积压是否过多
- 允许一定范围内的波动
- 需要达到一定规模才告警

❌ **不应该使用**：
- 监控不应该存在的数据
- 需要立即响应的异常
- 零容忍的业务规则

## 告警信息格式

### 存在模式告警
```
业务指标异常: {第一列的值} (共{记录数}条记录，显示前10条)
  [1] {第1行所有列}
  [2] {第2行所有列}
  ...
  [10] {第10行所有列}
  ... 还有 {剩余数量} 条记录
```

### 阈值模式告警
```
业务指标异常: {数值} (共{记录数}条记录，显示前10条)
  [1] {第1行所有列}
  [2] {第2行所有列}
  ...
```

## 配置建议

### 推荐配置1：异常数据监控
```
监控类型: 业务指标监控
SQL查询: SELECT ... FROM ... WHERE status = 'error'
阈值: 0
说明: 只要有错误状态的数据就告警
```

### 推荐配置2：数量监控
```
监控类型: 业务指标监控
SQL查询: SELECT COUNT(*) FROM ... WHERE status = 'pending'
阈值: 100
说明: 待处理数量超过100时告警
```

### 推荐配置3：详细数据监控
```
监控类型: 业务指标监控
SQL查询: SELECT id, name, status FROM ... WHERE need_attention = 1
阈值: 0
说明: 只要有需要关注的数据就告警，并显示详细信息
```

## 常见问题

### Q1: 阈值设为0和不填写有什么区别？

**A**: 没有区别，两者都会启用存在模式。
- 阈值 = 0：明确表示"有数据就告警"
- 阈值不填：默认为0，效果相同

### Q2: 如果我想要"没有数据时告警"怎么办？

**A**: 反向设计SQL查询：
```sql
-- 错误做法
SELECT * FROM orders WHERE status = 'completed'
阈值: 0  -- 这会在有完成订单时告警

-- 正确做法
SELECT CASE WHEN COUNT(*) = 0 THEN 1 ELSE 0 END 
FROM orders 
WHERE status = 'completed' 
AND created_at > NOW() - INTERVAL 1 DAY
阈值: 0  -- 这会在没有完成订单时告警
```

### Q3: 阈值可以是小数吗？

**A**: 可以，如果SQL返回小数（如平均值、百分比）：
```sql
SELECT AVG(response_time) FROM api_logs
阈值: 2.5  -- 平均响应时间超过2.5秒告警
```

### Q4: 如何测试告警是否正常？

**A**: 
1. 设置阈值为0
2. 确保SQL查询能返回数据
3. 等待监控周期（默认60秒）
4. 查看告警记录页面
5. 检查企业微信是否收到消息

## 最佳实践

### 1. 明确监控目的
- 监控异常 → 使用存在模式（阈值=0）
- 监控数量 → 使用阈值模式（阈值>0）

### 2. 合理设置阈值
- 存在模式：阈值设为0
- 阈值模式：根据历史数据和业务需求设置

### 3. 优化SQL查询
- 只查询需要告警的数据
- 使用WHERE条件过滤正常数据
- 返回有意义的列用于分析

### 4. 测试告警
- 先在测试环境验证
- 确认告警信息清晰
- 检查企业微信推送

### 5. 定期review
- 检查告警是否有用
- 调整阈值和SQL查询
- 优化告警频率

## 总结

**存在模式（阈值=0）**：
- 只要有数据就告警
- 适合异常监控
- 零容忍策略
- 立即响应

**阈值模式（阈值>0）**：
- 超过阈值才告警
- 适合数量监控
- 允许波动
- 达到规模才响应

根据你的业务需求选择合适的模式，让监控更加精准有效！

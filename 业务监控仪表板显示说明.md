# 业务监控仪表板显示功能说明

## 功能概述

业务指标监控现在已集成到监控仪表板中，可以直观地查看业务指标的当前状态和详细数据。

## 显示位置

在监控仪表板页面（http://localhost:8080/dashboard）的底部，应用监控和数据库监控下方，新增了"业务指标监控"区域。

## 显示内容

### 1. 卡片式布局
每个业务监控目标显示为一个独立的卡片，包含：

#### 卡片头部
- **监控目标名称**：显示在左侧
- **状态徽章**：显示在右侧
  - 🟢 正常（绿色）：指标在阈值范围内
  - 🟡 告警（黄色）：指标超过阈值
  - 🔴 异常（红色）：查询失败或其他错误

#### 卡片主体
- **主要指标值**：大号数字显示（如：125）
- **记录数量**：显示查询返回的总记录数
- **异常记录详情**：当触发告警时显示
  - 显示前5条异常记录
  - 每条记录显示所有列的值
  - 如果超过5条，显示剩余数量
- **更新时间**：显示最后检查时间

## 显示示例

### 示例1：正常状态

```
┌─────────────────────────────────────┐
│ 待处理订单监控          [正常]     │
├─────────────────────────────────────┤
│                                     │
│   45                                │
│   共 45 条记录                      │
│                                     │
│   ⏰ 2026-01-20 16:30:00           │
└─────────────────────────────────────┘
```

### 示例2：告警状态（显示详细记录）

```
┌─────────────────────────────────────┐
│ 待处理订单监控          [告警]     │
├─────────────────────────────────────┤
│                                     │
│   125                               │
│   共 125 条记录                     │
│                                     │
│   ⚠️ 异常记录（前5条）：            │
│   [1] 12345, 张三, 299.00, ...     │
│   [2] 12346, 李四, 599.00, ...     │
│   [3] 12347, 王五, 199.00, ...     │
│   [4] 12348, 赵六, 899.00, ...     │
│   [5] 12349, 孙七, 399.00, ...     │
│   ... 还有 120 条记录               │
│                                     │
│   ⏰ 2026-01-20 16:30:00           │
└─────────────────────────────────────┘
```

## 实际应用场景

### 场景1：监控待处理订单

**配置**：
```
监控目标名称: 待处理订单监控
SQL查询: 
  SELECT order_id, customer_name, amount, created_at 
  FROM orders 
  WHERE status='pending'
  ORDER BY created_at DESC
告警阈值: 100
```

**仪表板显示**：
- 正常时：显示当前待处理订单数量（如：45）
- 告警时：显示数量（如：125）+ 前5个订单的详细信息

**优势**：
- 一眼看到当前积压情况
- 告警时可以直接看到最早的订单
- 无需登录数据库查询

### 场景2：监控错误日志

**配置**：
```
监控目标名称: 应用错误监控
SQL查询:
  SELECT error_type, error_message, user_id, created_at 
  FROM error_logs 
  WHERE created_at > NOW() - INTERVAL 1 HOUR
  ORDER BY created_at DESC
告警阈值: 50
```

**仪表板显示**：
- 正常时：显示最近1小时的错误数（如：12）
- 告警时：显示错误数（如：87）+ 最近5个错误的详情

**优势**：
- 快速了解错误数量
- 看到错误类型分布
- 判断是系统问题还是个别用户问题

### 场景3：监控低库存商品

**配置**：
```
监控目标名称: 低库存商品监控
SQL查询:
  SELECT product_id, product_name, stock, category 
  FROM products 
  WHERE stock < 10
  ORDER BY stock ASC
告警阈值: 5
```

**仪表板显示**：
- 正常时：显示低库存商品数（如：3）
- 告警时：显示数量（如：8）+ 库存最少的5个商品

**优势**：
- 直观看到需要补货的商品数量
- 优先看到库存最少的商品
- 方便安排补货计划

### 场景4：监控支付失败

**配置**：
```
监控目标名称: 支付失败监控
SQL查询:
  SELECT payment_id, order_id, amount, fail_reason, created_at 
  FROM payments 
  WHERE status='failed' 
  AND created_at > NOW() - INTERVAL 1 HOUR
  ORDER BY created_at DESC
告警阈值: 10
```

**仪表板显示**：
- 正常时：显示失败数量（如：3）
- 告警时：显示数量（如：15）+ 最近5次失败的详情

**优势**：
- 快速发现支付问题
- 看到失败原因分布
- 判断是用户问题还是系统问题

## 显示特性

### 1. 自动刷新
- 每30秒自动更新数据
- 与服务器、应用、数据库监控同步刷新

### 2. 手动刷新
- 点击页面右上角的"刷新"按钮
- 立即更新所有监控数据，包括业务指标

### 3. 响应式布局
- 桌面端：每行显示2个卡片
- 平板端：每行显示1个卡片
- 移动端：自适应屏幕宽度

### 4. 颜色编码
- 🟢 绿色边框：正常状态
- 🟡 黄色边框：告警状态
- 🔴 红色边框：异常状态

### 5. 滚动查看
- 异常记录区域最大高度150px
- 超过高度自动显示滚动条
- 方便查看更多记录

## 数据显示规则

### 显示前5条记录
为了保持页面简洁，仪表板只显示前5条异常记录。

```
如果查询返回 3条记录  → 显示全部3条
如果查询返回 5条记录  → 显示全部5条
如果查询返回 20条记录 → 显示前5条，提示"还有15条记录"
```

### 为什么是5条？
1. **页面不会太长**：保持仪表板整洁
2. **快速浏览**：5条足够判断问题类型
3. **性能考虑**：减少DOM元素数量

### 查看全部记录
如果需要查看全部记录：
1. 点击"告警记录"页面查看完整告警信息（显示前10条）
2. 登录数据库直接查询
3. 查看监控详情页面（未来功能）

## 与告警记录的区别

### 仪表板显示
- **目的**：实时监控，快速浏览
- **显示内容**：当前最新状态
- **记录数量**：前5条
- **更新频率**：30秒自动刷新

### 告警记录页面
- **目的**：历史记录，详细分析
- **显示内容**：所有历史告警
- **记录数量**：前10条
- **更新频率**：手动刷新或新告警时

## 最佳实践

### 1. 合理命名
```
✅ 好的命名：
- "待处理订单监控"
- "最近1小时错误日志"
- "低库存商品（<10件）"

❌ 不好的命名：
- "监控1"
- "业务指标"
- "查询"
```

### 2. 选择关键列
```
✅ 推荐：
SELECT order_id, customer_name, amount, created_at
FROM orders WHERE status='pending'

❌ 不推荐：
SELECT * FROM orders WHERE status='pending'
（列太多，显示混乱）
```

### 3. 合理排序
```
✅ 推荐：
ORDER BY created_at DESC  -- 最新的在前
ORDER BY stock ASC        -- 库存最少的在前
ORDER BY priority DESC    -- 优先级最高的在前

❌ 不推荐：
不排序（随机顺序）
```

### 4. 控制返回数量
```
✅ 推荐：
-- 如果记录很多，可以限制返回数量
SELECT ... FROM ... WHERE ... LIMIT 100

❌ 不推荐：
-- 返回几千条记录（影响性能）
SELECT ... FROM ... WHERE ...
```

## 性能考虑

### 1. SQL查询优化
- 使用索引加速查询
- 避免全表扫描
- 限制返回列数和行数

### 2. 刷新频率
- 默认30秒刷新一次
- 可在config.py中调整CHECK_INTERVAL
- 建议不要低于30秒

### 3. 浏览器性能
- 业务监控卡片使用轻量级DOM
- 自动滚动区域限制高度
- 不会影响页面性能

## 故障排查

### 问题1：业务监控不显示

**可能原因**：
- 没有配置业务监控目标
- 监控目标被禁用
- SQL查询失败

**解决方法**：
1. 检查是否添加了业务监控目标
2. 确认监控目标状态为"启用"
3. 查看告警记录是否有错误信息

### 问题2：显示"暂无数据"

**可能原因**：
- 监控任务还未执行
- SQL查询返回空结果

**解决方法**：
1. 等待60秒（默认监控间隔）
2. 手动点击刷新按钮
3. 检查SQL查询是否正确

### 问题3：详细记录不显示

**可能原因**：
- 指标未超过阈值（正常状态）
- SQL查询只返回COUNT(*)

**解决方法**：
1. 检查当前值是否超过阈值
2. 修改SQL查询，返回详细列而不是COUNT(*)

### 问题4：刷新后数据不更新

**可能原因**：
- 浏览器缓存
- JavaScript错误

**解决方法**：
1. 强制刷新浏览器（Cmd+Shift+R）
2. 打开浏览器控制台查看错误
3. 清除浏览器缓存

## 未来改进

### 计划功能
1. **图表展示**：将业务指标用折线图展示趋势
2. **自定义显示**：选择显示哪些列
3. **导出数据**：导出异常记录为CSV
4. **钻取功能**：点击卡片查看详细历史
5. **对比功能**：与昨天/上周同期对比

## 总结

业务监控仪表板显示功能让你可以：
- ✅ 实时查看业务指标状态
- ✅ 快速发现异常情况
- ✅ 直接看到异常记录详情
- ✅ 无需登录数据库查询
- ✅ 与其他监控统一管理

这是一个强大的业务监控工具，帮助你及时发现和处理业务问题！

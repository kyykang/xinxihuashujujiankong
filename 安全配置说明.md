# 安全配置说明

## 密码加密功能

系统已实现密码加密存储功能，所有敏感信息（如数据库密码、SSH密码等）都会使用AES加密算法加密后存储在数据库中。

## 加密机制

### 1. 加密算法
- 使用 **AES (Fernet)** 对称加密算法
- 密钥长度：256位
- 加密后的数据使用Base64编码存储

### 2. 加密字段
系统会自动加密以下敏感字段：
- `password` - 所有类型的密码（数据库密码、SSH密码等）
- `key_file` - SSH密钥文件路径

### 3. 密钥管理
- 加密密钥存储在 `.secret_key` 文件中
- 首次运行时自动生成密钥
- 密钥文件权限设置为 `600`（仅所有者可读写）
- **密钥文件已添加到 .gitignore，不会被提交到Git**

## 使用说明

### 首次使用

1. **安装依赖**
   ```bash
   pip3 install -r requirements.txt
   ```

2. **启动系统**
   ```bash
   python3 app.py
   ```
   
   系统会自动生成加密密钥文件 `.secret_key`

3. **备份密钥**
   ```bash
   cp .secret_key .secret_key.backup
   ```
   
   将备份文件保存到安全位置（如加密的U盘、密码管理器等）

### 迁移现有数据

如果你已经有现有的监控配置（明文密码），需要运行迁移脚本：

```bash
# 1. 备份数据库
cp monitoring.db monitoring.db.backup

# 2. 运行迁移脚本
python3 migrate_encrypt_passwords.py

# 3. 验证加密结果
python3 migrate_encrypt_passwords.py verify
```

### 添加新的监控目标

添加新监控目标时，系统会自动加密密码，无需手动操作。

## 安全建议

### 1. 密钥文件保护

**重要：密钥文件是解密所有密码的唯一凭证！**

- ✅ **必须做**：
  - 定期备份密钥文件到安全位置
  - 设置严格的文件权限（600）
  - 不要将密钥文件提交到Git
  - 不要通过邮件或聊天工具传输密钥

- ❌ **禁止做**：
  - 将密钥文件放在公开位置
  - 与他人共享密钥文件
  - 将密钥硬编码在代码中

### 2. 系统访问控制

当前系统没有用户认证功能，建议：

- 使用防火墙限制访问IP
- 使用反向代理（如Nginx）添加HTTP基本认证
- 部署在内网环境，不要直接暴露到公网
- 使用VPN访问监控系统

### 3. 数据库安全

- 定期备份数据库文件
- 设置数据库文件权限为 `600`
- 考虑使用数据库加密（如SQLCipher）

### 4. 网络安全

- 使用HTTPS加密传输（配置SSL证书）
- 启用防火墙，只开放必要端口
- 使用SSH密钥认证代替密码认证

## 密钥丢失处理

如果密钥文件丢失：

1. **无法恢复已加密的密码**
   - 加密是不可逆的，没有密钥无法解密

2. **解决方案**：
   - 删除现有数据库
   - 重新生成密钥
   - 重新配置所有监控目标

3. **预防措施**：
   - 定期备份密钥文件
   - 使用密码管理器保存密钥
   - 在多个安全位置保存备份

## 技术细节

### 加密流程

```
明文密码 → UTF-8编码 → AES加密 → Base64编码 → 存储到数据库
```

### 解密流程

```
数据库读取 → Base64解码 → AES解密 → UTF-8解码 → 明文密码
```

### 向后兼容

系统支持向后兼容：
- 自动检测密码是否已加密
- 未加密的旧数据仍可正常使用
- 运行迁移脚本后统一加密

## 常见问题

### Q: 密钥文件可以修改吗？
A: 不建议修改。如果修改了密钥，所有已加密的数据都无法解密。

### Q: 可以在多台服务器上使用同一个密钥吗？
A: 可以，但需要确保密钥文件在所有服务器上保持一致。

### Q: 如何更换密钥？
A: 需要先用旧密钥解密所有数据，然后用新密钥重新加密。建议使用迁移脚本。

### Q: 加密会影响性能吗？
A: 影响很小。加密/解密操作只在保存和读取配置时进行，不影响监控任务执行。

## 进一步增强安全性

如需更高的安全性，可以考虑：

1. **添加用户认证系统**
   - 实现登录功能
   - 基于角色的访问控制（RBAC）
   - 会话管理和超时

2. **使用硬件安全模块（HSM）**
   - 将密钥存储在硬件设备中
   - 提供更高级别的密钥保护

3. **实施审计日志**
   - 记录所有敏感操作
   - 定期审查访问日志

4. **双因素认证（2FA）**
   - 增加额外的安全层
   - 防止密码泄露导致的未授权访问

## 联系支持

如有安全相关问题或建议，请通过以下方式联系：
- 提交GitHub Issue
- 发送邮件到安全团队

---

**最后更新**: 2026-01-21
**版本**: 1.0

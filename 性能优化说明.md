# 系统性能优化说明

## 优化内容

### 1. 并行执行监控任务
**问题**：原来所有监控任务串行执行，如果有10个监控目标，每个需要5秒，总共需要50秒。

**优化**：使用线程池并行执行，最多10个并发任务同时运行。
- 10个监控目标现在只需要约5秒（最慢的那个任务的时间）
- 大幅提升监控效率

### 2. 减少超时时间
**优化前**：
- SSH连接超时：10秒
- HTTP请求超时：5秒
- 数据库连接超时：5秒

**优化后**：
- SSH连接超时：5秒
- HTTP请求超时：3秒
- 数据库连接超时：3秒

### 3. CPU检查优化
**优化前**：`psutil.cpu_percent(interval=1)` 每次等待1秒采样

**优化后**：`psutil.cpu_percent(interval=0)` 立即返回（使用上次采样数据）
- 速度提升：从1秒降到几乎0秒
- 注意：第一次调用可能返回0，但后续调用会返回准确数据

## 性能对比

### 优化前
- 1个远程服务器监控：约11秒（10秒连接 + 1秒CPU检查）
- 5个监控目标：约55秒（串行执行）
- 10个监控目标：约110秒

### 优化后
- 1个远程服务器监控：约5秒（5秒连接 + 0秒CPU检查）
- 5个监控目标：约5秒（并行执行，取最慢的）
- 10个监控目标：约5-10秒（并行执行）

**提升幅度**：10-20倍

## 监控日志

系统现在会在控制台输出监控任务的执行情况：
```
监控任务完成: 8 成功, 0 失败, 耗时 3.45秒
```

## 建议配置

### 监控间隔
在 `config.py` 中调整：
```python
CHECK_INTERVAL = 60  # 60秒检查一次（推荐）
```

- 如果监控目标少（<5个）：可以设置为30秒
- 如果监控目标多（>10个）：建议60秒或更长
- 远程服务器多的情况：建议120秒

### 线程池大小
在 `scheduler.py` 中调整：
```python
executor = ThreadPoolExecutor(max_workers=10)
```

- 监控目标少：可以设置为5
- 监控目标多：可以设置为20
- 注意：过多线程可能导致系统负载过高

## 进一步优化建议

### 1. 连接池（未实现）
为SSH连接和数据库连接建立连接池，避免每次重新连接。

### 2. 缓存机制（未实现）
对于变化不频繁的数据（如系统信息），可以缓存一段时间。

### 3. 异步执行（未实现）
使用 asyncio 替代线程池，进一步提升性能。

### 4. 分布式监控（未实现）
如果监控目标非常多，可以部署多个监控节点。

## 故障排查

### 如果系统还是很慢

1. **检查网络连接**
   - 远程服务器网络延迟高
   - 防火墙阻止连接

2. **检查监控目标配置**
   - 错误的IP地址或端口
   - 错误的认证信息

3. **查看控制台日志**
   ```bash
   # 运行系统时查看日志
   python3 app.py
   ```
   
   查看是否有：
   - SSH连接失败
   - 超时错误
   - 其他异常

4. **减少监控目标**
   - 暂时禁用一些监控目标
   - 测试是否是某个特定目标导致的慢

5. **增加监控间隔**
   - 将 CHECK_INTERVAL 从 60 改为 120 或更长

## 测试建议

1. **添加本地监控目标测试**
   - 本地服务器监控（最快）
   - 本地存储监控

2. **逐步添加远程监控**
   - 先添加1个远程服务器
   - 观察性能
   - 再逐步增加

3. **使用测试连接功能**
   - 在添加监控目标时先测试连接
   - 确保连接速度可接受

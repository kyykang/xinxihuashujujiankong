# 业务监控详细告警功能说明

## 功能概述

业务监控现在会在告警信息中显示详细的查询结果，而不仅仅是一个数字。当触发告警时，系统会列出所有异常记录的详细信息。

## 工作原理

### 之前的行为
```
SQL查询返回: 150条记录
告警信息: "业务指标异常: 150"
```
只显示数量，不知道具体是哪些记录异常。

### 现在的行为
```
SQL查询返回: 150条记录
告警信息: 
"业务指标异常: 150 (共150条记录，显示前10条)
  [1] 订单ID: 12345, 状态: pending, 创建时间: 2026-01-20 10:00:00
  [2] 订单ID: 12346, 状态: pending, 创建时间: 2026-01-20 10:05:00
  [3] 订单ID: 12347, 状态: pending, 创建时间: 2026-01-20 10:10:00
  ...
  [10] 订单ID: 12354, 状态: pending, 创建时间: 2026-01-20 10:45:00
  ... 还有 140 条记录"
```
显示详细信息，可以直接看到具体的异常记录。

## 使用示例

### 示例1：监控待处理订单（显示详细信息）

#### 配置
```
监控类型: 业务指标监控
数据库类型: MySQL
主机地址: localhost
端口: 3306
用户名: root
数据库名: ecommerce

SQL查询:
SELECT order_id, customer_name, amount, created_at 
FROM orders 
WHERE status='pending' 
ORDER BY created_at DESC

告警阈值: 100
```

#### 告警效果
当待处理订单超过100个时，告警信息会显示：
```
业务指标异常: 125 (共125条记录，显示前10条)
  [1] 12345, 张三, 299.00, 2026-01-20 10:00:00
  [2] 12346, 李四, 599.00, 2026-01-20 10:05:00
  [3] 12347, 王五, 199.00, 2026-01-20 10:10:00
  [4] 12348, 赵六, 899.00, 2026-01-20 10:15:00
  [5] 12349, 孙七, 399.00, 2026-01-20 10:20:00
  [6] 12350, 周八, 499.00, 2026-01-20 10:25:00
  [7] 12351, 吴九, 699.00, 2026-01-20 10:30:00
  [8] 12352, 郑十, 799.00, 2026-01-20 10:35:00
  [9] 12353, 钱一, 999.00, 2026-01-20 10:40:00
  [10] 12354, 陈二, 1299.00, 2026-01-20 10:45:00
  ... 还有 115 条记录
```

**优势**：
- 可以直接看到是哪些订单待处理
- 可以看到订单金额和时间
- 方便快速定位问题

### 示例2：监控错误日志（显示错误详情）

#### 配置
```
SQL查询:
SELECT error_type, error_message, user_id, created_at 
FROM error_logs 
WHERE created_at > NOW() - INTERVAL 1 HOUR 
ORDER BY created_at DESC

告警阈值: 50
```

#### 告警效果
```
业务指标异常: 87 (共87条记录，显示前10条)
  [1] DatabaseError, Connection timeout, 1001, 2026-01-20 15:55:00
  [2] DatabaseError, Connection timeout, 1002, 2026-01-20 15:54:30
  [3] DatabaseError, Connection timeout, 1003, 2026-01-20 15:54:00
  [4] APIError, Rate limit exceeded, 2001, 2026-01-20 15:53:30
  [5] APIError, Rate limit exceeded, 2002, 2026-01-20 15:53:00
  [6] DatabaseError, Connection timeout, 1004, 2026-01-20 15:52:30
  [7] ValidationError, Invalid email format, 3001, 2026-01-20 15:52:00
  [8] DatabaseError, Connection timeout, 1005, 2026-01-20 15:51:30
  [9] APIError, Rate limit exceeded, 2003, 2026-01-20 15:51:00
  [10] DatabaseError, Connection timeout, 1006, 2026-01-20 15:50:30
  ... 还有 77 条记录
```

**优势**：
- 可以看到错误类型分布
- 可以看到具体的错误信息
- 可以看到受影响的用户
- 方便判断是系统问题还是个别用户问题

### 示例3：监控低库存商品（显示商品信息）

#### 配置
```
SQL查询:
SELECT product_id, product_name, stock, category 
FROM products 
WHERE stock < 10 
ORDER BY stock ASC

告警阈值: 5
```

#### 告警效果
```
业务指标异常: 8 (共8条记录)
  [1] P1001, iPhone 15 Pro, 2, 手机
  [2] P1002, MacBook Pro, 3, 电脑
  [3] P2001, AirPods Pro, 5, 耳机
  [4] P3001, iPad Air, 6, 平板
  [5] P1003, Apple Watch, 7, 手表
  [6] P2002, Magic Keyboard, 8, 配件
  [7] P3002, Apple Pencil, 9, 配件
  [8] P1004, Mac Mini, 9, 电脑
```

**优势**：
- 直接看到哪些商品需要补货
- 可以看到库存数量
- 可以按类别安排补货

### 示例4：监控支付失败（显示失败原因）

#### 配置
```
SQL查询:
SELECT payment_id, order_id, amount, fail_reason, created_at 
FROM payments 
WHERE status='failed' 
AND created_at > NOW() - INTERVAL 1 HOUR 
ORDER BY created_at DESC

告警阈值: 10
```

#### 告警效果
```
业务指标异常: 15 (共15条记录，显示前10条)
  [1] PAY001, ORD12345, 299.00, 银行卡余额不足, 2026-01-20 16:00:00
  [2] PAY002, ORD12346, 599.00, 支付超时, 2026-01-20 15:58:00
  [3] PAY003, ORD12347, 199.00, 银行卡余额不足, 2026-01-20 15:56:00
  [4] PAY004, ORD12348, 899.00, 网络错误, 2026-01-20 15:54:00
  [5] PAY005, ORD12349, 399.00, 银行卡余额不足, 2026-01-20 15:52:00
  [6] PAY006, ORD12350, 499.00, 支付超时, 2026-01-20 15:50:00
  [7] PAY007, ORD12351, 699.00, 银行卡余额不足, 2026-01-20 15:48:00
  [8] PAY008, ORD12352, 799.00, 网络错误, 2026-01-20 15:46:00
  [9] PAY009, ORD12353, 999.00, 银行卡余额不足, 2026-01-20 15:44:00
  [10] PAY010, ORD12354, 1299.00, 支付超时, 2026-01-20 15:42:00
  ... 还有 5 条记录
```

**优势**：
- 可以看到失败原因分布
- 可以判断是用户问题还是系统问题
- 方便针对性解决问题

## SQL查询建议

### 推荐做法：返回详细信息

#### ✅ 好的查询（返回多列）
```sql
-- 待处理订单
SELECT order_id, customer_name, amount, created_at 
FROM orders 
WHERE status='pending'

-- 错误日志
SELECT error_type, error_message, user_id, created_at 
FROM error_logs 
WHERE created_at > NOW() - INTERVAL 1 HOUR

-- 低库存商品
SELECT product_id, product_name, stock, category 
FROM products 
WHERE stock < 10
```

#### ❌ 不推荐的查询（只返回数量）
```sql
-- 只返回数量，看不到详细信息
SELECT COUNT(*) FROM orders WHERE status='pending'

-- 只返回ID，信息不够
SELECT order_id FROM orders WHERE status='pending'
```

### SQL查询技巧

#### 技巧1：限制返回列数
```sql
-- 只返回最重要的信息，避免信息过多
SELECT order_id, amount, created_at 
FROM orders 
WHERE status='pending'
-- 不要: SELECT * FROM orders WHERE status='pending'
```

#### 技巧2：排序
```sql
-- 按时间倒序，最新的记录在前面
ORDER BY created_at DESC

-- 按严重程度排序
ORDER BY priority DESC, created_at DESC

-- 按数量排序（库存从少到多）
ORDER BY stock ASC
```

#### 技巧3：限制返回行数（可选）
```sql
-- 如果记录太多，可以在SQL中限制
SELECT order_id, customer_name, amount 
FROM orders 
WHERE status='pending'
ORDER BY created_at DESC
LIMIT 100
```

#### 技巧4：添加有用的计算字段
```sql
-- 添加等待时间
SELECT 
    order_id, 
    customer_name, 
    amount,
    TIMESTAMPDIFF(HOUR, created_at, NOW()) as wait_hours
FROM orders 
WHERE status='pending'
ORDER BY wait_hours DESC
```

## 显示限制

### 最多显示10条记录
为了避免告警信息过长，系统最多显示前10条记录。

```
如果查询返回 5条记录  → 显示全部5条
如果查询返回 10条记录 → 显示全部10条
如果查询返回 50条记录 → 显示前10条，提示"还有40条记录"
```

### 为什么限制10条？
1. **告警信息不会太长**：方便阅读
2. **企业微信消息限制**：消息长度有限制
3. **快速定位问题**：前10条通常足够判断问题

### 如何查看全部记录？
如果需要查看全部记录：
1. 登录数据库直接查询
2. 查看监控详情页面（未来功能）
3. 导出告警记录（未来功能）

## 告警信息格式

### 格式说明
```
业务指标异常: {第一列的值} (共{总记录数}条记录，显示前{显示数量}条)
  [1] {第1行所有列的值，用逗号分隔}
  [2] {第2行所有列的值，用逗号分隔}
  ...
  [10] {第10行所有列的值，用逗号分隔}
  ... 还有 {剩余记录数} 条记录
```

### 实际示例
```
业务指标异常: 125 (共125条记录，显示前10条)
  [1] 12345, 张三, 299.00, 2026-01-20 10:00:00
  [2] 12346, 李四, 599.00, 2026-01-20 10:05:00
  ...
  [10] 12354, 陈二, 1299.00, 2026-01-20 10:45:00
  ... 还有 115 条记录
```

## 告警页面显示

### 优化的显示效果
- 使用等宽字体（monospace）
- 保留换行和空格（pre-wrap）
- 自动换行，不会横向滚动
- 清晰的层次结构

### 查看告警
1. 访问：http://localhost:8080/alerts
2. 在告警记录表格中查看详细信息
3. 告警信息会完整显示，包括所有详细记录

## 注意事项

### 1. SQL查询性能
```
⚠️ 注意：
- 不要返回太多列（建议≤10列）
- 不要返回大文本字段（如BLOB）
- 使用索引优化查询速度
- 考虑使用LIMIT限制返回行数
```

### 2. 告警频率
```
⚠️ 注意：
- 如果每次都触发告警，会产生大量重复信息
- 建议设置合理的阈值
- 考虑使用告警抑制（未来功能）
```

### 3. 企业微信消息长度
```
⚠️ 注意：
- 企业微信消息有长度限制（约2048字符）
- 如果告警信息太长，可能被截断
- 建议SQL查询只返回必要的列
```

## 对比总结

### 之前
```
优点：
- 简洁

缺点：
- 只知道数量，不知道具体内容
- 需要登录数据库查询详情
- 无法快速定位问题
```

### 现在
```
优点：
- 显示详细记录
- 可以直接看到异常内容
- 快速定位问题
- 无需登录数据库

缺点：
- 告警信息较长
- 只显示前10条
```

## 最佳实践

1. **SQL查询返回有意义的列**
   - 包含ID、名称、时间等关键信息
   - 不要只返回COUNT(*)

2. **合理排序**
   - 最重要的记录排在前面
   - 通常按时间倒序

3. **控制返回列数**
   - 3-6列最佳
   - 不超过10列

4. **设置合理阈值**
   - 避免频繁告警
   - 提前预警但不过度敏感

5. **定期review告警**
   - 检查告警是否有用
   - 调整SQL查询和阈值

{% extends "base.html" %}

{% block title %}监控仪表板 - 信息化运维监控系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2">监控仪表板</h1>
        <small class="text-muted">
            <i class="bi bi-info-circle"></i> 
            数据每<span id="refreshInterval">加载中...</span>秒自动更新，点击刷新按钮可立即更新统计数据
        </small>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-sm btn-outline-secondary" id="refreshBtn" onclick="refreshDashboard()" title="刷新统计数据">
            <i class="bi bi-arrow-clockwise"></i> 刷新
        </button>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">监控目标</h6>
                        <h2 class="mt-2 mb-0">{{ total_targets }}</h2>
                    </div>
                    <i class="bi bi-bullseye" style="font-size: 2.5rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">近1小时告警</h6>
                        <h2 class="mt-2 mb-0">{{ error_count }}</h2>
                    </div>
                    <i class="bi bi-exclamation-triangle" style="font-size: 2.5rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">在线服务</h6>
                        <h2 class="mt-2 mb-0" id="onlineCount">-</h2>
                    </div>
                    <i class="bi bi-check-circle" style="font-size: 2.5rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">离线/异常</h6>
                        <h2 class="mt-2 mb-0" id="offlineCount">-</h2>
                    </div>
                    <i class="bi bi-x-circle" style="font-size: 2.5rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 服务器监控图表 -->
<div class="row mb-4" id="serverChartsContainer">
    {% for target in targets %}
    {% if target.type == 'server' and target.latest_data %}
    <div class="col-md-6 mb-3 draggable-item" data-id="{{ target.id }}" data-type="server">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center" style="cursor: move;">
                <h5 class="mb-0">
                    <i class="bi bi-grip-vertical text-muted me-2"></i>
                    <i class="bi bi-server"></i> {{ target.name }}
                </h5>
                <span class="badge {% if target.latest_data.status == 'normal' %}bg-success{% else %}bg-danger{% endif %}">
                    {{ '正常' if target.latest_data.status == 'normal' else '异常' }}
                </span>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 200px;">
                    <canvas id="chart-{{ target.id }}"></canvas>
                    <div id="loading-{{ target.id }}" class="text-center" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <div class="mt-2 text-muted">加载图表中...</div>
                    </div>
                </div>
                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <small class="text-muted" id="update-time-{{ target.id }}">最后更新: {{ target.latest_data.created_at | local_time }}</small>
                    {% set metric_data = target.latest_data.metric_value | from_json %}
                    <small class="text-muted">
                        <i class="bi bi-stopwatch"></i> 耗时: {{ metric_data.execution_time|default(0)|round(2) }}秒
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<!-- 应用和数据库状态 -->
<div class="row" id="appDbContainer">
    <div class="col-md-6 draggable-item" data-id="applications" data-type="section">
        <div class="card">
            <div class="card-header" style="cursor: move;">
                <h5 class="mb-0">
                    <i class="bi bi-grip-vertical text-muted me-2"></i>
                    <i class="bi bi-globe"></i> 应用监控
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group" id="applicationList">
                    {% if targets|selectattr('type', 'equalto', 'application')|list|length == 0 %}
                    <div class="list-group-item text-muted text-center">暂无应用监控</div>
                    {% else %}
                    {% for target in targets %}
                    {% if target.type == 'application' %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>{{ target.name }}</strong>
                            {% if target.latest_data %}
                            <span class="badge {% if target.latest_data.status == 'normal' %}bg-success{% else %}bg-danger{% endif %}">
                                {{ '在线' if target.latest_data.status == 'normal' else '离线' }}
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">未知</span>
                            {% endif %}
                        </div>
                        {% if target.latest_data %}
                        {% set app_data = target.latest_data.metric_value | from_json %}
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">{{ target.latest_data.created_at | local_time }}</small>
                            <small class="text-muted">
                                <i class="bi bi-stopwatch"></i> 耗时: {{ app_data.execution_time|default(0)|round(2) }}秒
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 draggable-item" data-id="databases" data-type="section">
        <div class="card">
            <div class="card-header" style="cursor: move;">
                <h5 class="mb-0">
                    <i class="bi bi-grip-vertical text-muted me-2"></i>
                    <i class="bi bi-database"></i> 数据库监控
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group" id="databaseList">
                    {% if targets|selectattr('type', 'equalto', 'database')|list|length == 0 %}
                    <div class="list-group-item text-muted text-center">暂无数据库监控</div>
                    {% else %}
                    {% for target in targets %}
                    {% if target.type == 'database' %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>{{ target.name }}</strong>
                            {% if target.latest_data %}
                            <span class="badge {% if target.latest_data.status == 'normal' %}bg-success{% else %}bg-danger{% endif %}">
                                {{ '在线' if target.latest_data.status == 'normal' else '离线' }}
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">未知</span>
                            {% endif %}
                        </div>
                        {% if target.latest_data %}
                        {% set db_data = target.latest_data.metric_value | from_json %}
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">{{ target.latest_data.created_at | local_time }}</small>
                            <small class="text-muted">
                                <i class="bi bi-stopwatch"></i> 耗时: {{ db_data.execution_time|default(0)|round(2) }}秒
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 业务指标监控 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> 业务指标监控</h5>
            </div>
            <div class="card-body">
                {% set business_targets = targets|selectattr('type', 'equalto', 'business')|list %}
                {% if business_targets|length == 0 %}
                <div class="text-muted text-center py-3">暂无业务指标监控</div>
                {% else %}
                <div class="row" id="businessMetricsList">
                    {% for target in business_targets %}
                    <div class="col-md-6 mb-3 draggable-item" data-id="{{ target.id }}" data-type="business">
                        <div class="card border-{% if target.latest_data and target.latest_data.status == 'warning' %}warning{% else %}secondary{% endif %}">
                            <div class="card-header d-flex justify-content-between align-items-center" style="cursor: move;">
                                <strong>
                                    <i class="bi bi-grip-vertical text-muted me-2"></i>
                                    {{ target.name }}
                                </strong>
                                {% if target.latest_data %}
                                <span class="badge {% if target.latest_data.status == 'normal' %}bg-success{% elif target.latest_data.status == 'warning' %}bg-warning{% else %}bg-danger{% endif %}">
                                    {% if target.latest_data.status == 'normal' %}正常
                                    {% elif target.latest_data.status == 'warning' %}告警
                                    {% else %}异常{% endif %}
                                </span>
                                {% else %}
                                <span class="badge bg-secondary">未知</span>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                {% if target.latest_data %}
                                {% set metric_data = target.latest_data.metric_value | from_json %}
                                
                                <!-- 显示所有数据 -->
                                {% if metric_data.all_data and metric_data.all_data|length > 0 %}
                                <div class="{% if metric_data.alert %}alert alert-warning{% else %}border rounded p-2{% endif %} mb-0">
                                    {% if metric_data.alert %}
                                    <strong>异常记录（前5条）：</strong>
                                    {% else %}
                                    <strong>查询结果（前5条）：</strong>
                                    {% endif %}
                                    <small class="text-muted ms-2">共 {{ metric_data.row_count }} 条记录</small>
                                    <div style="font-family: monospace; font-size: 0.85em; margin-top: 10px; max-height: 150px; overflow-y: auto;">
                                        {% for row in metric_data.all_data[:5] %}
                                        <div class="mb-1">
                                            [{{ loop.index }}] {{ row | join(', ') }}
                                        </div>
                                        {% endfor %}
                                        {% if metric_data.row_count > 5 %}
                                        <div class="text-muted mt-2">
                                            ... 还有 {{ metric_data.row_count - 5 }} 条记录
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% elif metric_data.detail_data and metric_data.detail_data|length > 0 %}
                                <!-- 兼容旧数据：如果没有all_data但有detail_data -->
                                <div class="alert alert-warning mb-0">
                                    <strong>异常记录（前5条）：</strong>
                                    <div style="font-family: monospace; font-size: 0.85em; margin-top: 10px; max-height: 150px; overflow-y: auto;">
                                        {% for row in metric_data.detail_data[:5] %}
                                        <div class="mb-1">
                                            [{{ loop.index }}] {{ row | join(', ') }}
                                        </div>
                                        {% endfor %}
                                        {% if metric_data.row_count > 5 %}
                                        <div class="text-muted mt-2">
                                            ... 还有 {{ metric_data.row_count - 5 }} 条记录
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> {{ target.latest_data.created_at | local_time }}
                                    </small>
                                </div>
                                {% else %}
                                <div class="text-muted">暂无数据</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 备份文件监控 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-archive"></i> 备份文件监控</h5>
            </div>
            <div class="card-body">
                {% set backup_targets = targets|selectattr('type', 'equalto', 'backup')|list %}
                {% if backup_targets|length == 0 %}
                <div class="text-muted text-center py-3">暂无备份文件监控</div>
                {% else %}
                <div class="row" id="backupFilesList">
                    {% for target in backup_targets %}
                    <div class="col-md-6 mb-3 draggable-item" data-id="{{ target.id }}" data-type="backup">
                        <div class="card border-{% if target.latest_data and target.latest_data.status == 'warning' %}warning{% elif target.latest_data and target.latest_data.status == 'error' %}danger{% else %}secondary{% endif %}">
                            <div class="card-header d-flex justify-content-between align-items-center" style="cursor: move;">
                                <strong>
                                    <i class="bi bi-grip-vertical text-muted me-2"></i>
                                    {{ target.name }}
                                </strong>
                                {% if target.latest_data %}
                                <span class="badge {% if target.latest_data.status == 'normal' %}bg-success{% elif target.latest_data.status == 'warning' %}bg-warning{% else %}bg-danger{% endif %}">
                                    {% if target.latest_data.status == 'normal' %}正常
                                    {% elif target.latest_data.status == 'warning' %}告警
                                    {% else %}异常{% endif %}
                                </span>
                                {% else %}
                                <span class="badge bg-secondary">未知</span>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                {% if target.latest_data %}
                                {% set backup_data = target.latest_data.metric_value | from_json %}
                                
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><i class="bi bi-folder"></i> 备份目录:</span>
                                        <code>{{ backup_data.backup_path }}</code>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><i class="bi bi-file-earmark"></i> 文件数量:</span>
                                        <strong>{{ backup_data.total_count }}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span><i class="bi bi-hdd"></i> 总大小:</span>
                                        <strong>{{ backup_data.total_size_human }}</strong>
                                    </div>
                                </div>
                                
                                {% if backup_data.alert and backup_data.alert_message %}
                                <div class="alert alert-warning mb-2">
                                    <i class="bi bi-exclamation-triangle"></i> {{ backup_data.alert_message }}
                                </div>
                                {% endif %}
                                
                                {% if backup_data.files and backup_data.files|length > 0 %}
                                <div class="border rounded p-2">
                                    <strong>最新备份文件（前5个）：</strong>
                                    <div style="font-family: monospace; font-size: 0.85em; margin-top: 10px; max-height: 150px; overflow-y: auto;">
                                        {% for file in backup_data.files[:5] %}
                                        <div class="mb-1 d-flex justify-content-between">
                                            <span class="text-truncate" style="max-width: 60%;">{{ file.name }}</span>
                                            <span class="text-muted">{{ file.size_human }} | {{ file.mtime_str }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> {{ target.latest_data.created_at | local_time }}
                                    </small>
                                </div>
                                {% else %}
                                <div class="text-muted">暂无数据</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SortableJS库 -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// 存储图表实例
const charts = {};

// 初始化拖拽排序
function initDragAndDrop() {
    // 服务器图表容器
    const serverContainer = document.getElementById('serverChartsContainer');
    if (serverContainer) {
        new Sortable(serverContainer, {
            animation: 150,
            handle: '.card-header',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: function() {
                saveDashboardLayout();
            }
        });
    }
    
    // 应用和数据库容器
    const appDbContainer = document.getElementById('appDbContainer');
    if (appDbContainer) {
        new Sortable(appDbContainer, {
            animation: 150,
            handle: '.card-header',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: function() {
                saveDashboardLayout();
            }
        });
    }
    
    // 业务指标容器
    const businessContainer = document.getElementById('businessMetricsList');
    if (businessContainer) {
        new Sortable(businessContainer, {
            animation: 150,
            handle: '.card-header',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: function() {
                saveDashboardLayout();
            }
        });
    }
    
    // 备份文件容器
    const backupContainer = document.getElementById('backupFilesList');
    if (backupContainer) {
        new Sortable(backupContainer, {
            animation: 150,
            handle: '.card-header',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: function() {
                saveDashboardLayout();
            }
        });
    }
}

// 保存仪表板布局到localStorage
function saveDashboardLayout() {
    const layout = {
        servers: [],
        appDb: [],
        business: [],
        backups: []
    };
    
    // 保存服务器图表顺序
    const serverItems = document.querySelectorAll('#serverChartsContainer .draggable-item');
    serverItems.forEach(item => {
        layout.servers.push(item.dataset.id);
    });
    
    // 保存应用和数据库顺序
    const appDbItems = document.querySelectorAll('#appDbContainer .draggable-item');
    appDbItems.forEach(item => {
        layout.appDb.push(item.dataset.id);
    });
    
    // 保存业务指标顺序
    const businessItems = document.querySelectorAll('#businessMetricsList .draggable-item');
    businessItems.forEach(item => {
        layout.business.push(item.dataset.id);
    });
    
    // 保存备份文件顺序
    const backupItems = document.querySelectorAll('#backupFilesList .draggable-item');
    backupItems.forEach(item => {
        layout.backups.push(item.dataset.id);
    });
    
    localStorage.setItem('dashboardLayout', JSON.stringify(layout));
    console.log('布局已保存:', layout);
}

// 恢复仪表板布局
function restoreDashboardLayout() {
    const layoutStr = localStorage.getItem('dashboardLayout');
    if (!layoutStr) return;
    
    try {
        const layout = JSON.parse(layoutStr);
        console.log('恢复布局:', layout);
        
        // 恢复服务器图表顺序
        if (layout.servers && layout.servers.length > 0) {
            const serverContainer = document.getElementById('serverChartsContainer');
            if (serverContainer) {
                layout.servers.forEach(id => {
                    const item = serverContainer.querySelector(`[data-id="${id}"]`);
                    if (item) {
                        serverContainer.appendChild(item);
                    }
                });
            }
        }
        
        // 恢复应用和数据库顺序
        if (layout.appDb && layout.appDb.length > 0) {
            const appDbContainer = document.getElementById('appDbContainer');
            if (appDbContainer) {
                layout.appDb.forEach(id => {
                    const item = appDbContainer.querySelector(`[data-id="${id}"]`);
                    if (item) {
                        appDbContainer.appendChild(item);
                    }
                });
            }
        }
        
        // 恢复业务指标顺序
        if (layout.business && layout.business.length > 0) {
            const businessContainer = document.getElementById('businessMetricsList');
            if (businessContainer) {
                layout.business.forEach(id => {
                    const item = businessContainer.querySelector(`[data-id="${id}"]`);
                    if (item) {
                        businessContainer.appendChild(item);
                    }
                });
            }
        }
        
        // 恢复备份文件顺序
        if (layout.backups && layout.backups.length > 0) {
            const backupContainer = document.getElementById('backupFilesList');
            if (backupContainer) {
                layout.backups.forEach(id => {
                    const item = backupContainer.querySelector(`[data-id="${id}"]`);
                    if (item) {
                        backupContainer.appendChild(item);
                    }
                });
            }
        }
    } catch (e) {
        console.error('恢复布局失败:', e);
    }
}

// 初始化服务器监控图表
function initServerCharts() {
    {% for target in targets %}
    {% if target.type == 'server' and target.latest_data %}
    try {
        const metricValue = '{{ target.latest_data.metric_value | safe }}';
        console.log('初始化图表 {{ target.id }}，数据:', metricValue);
        
        const data{{ target.id }} = JSON.parse(metricValue);
        
        const ctx{{ target.id }} = document.getElementById('chart-{{ target.id }}');
        if (ctx{{ target.id }}) {
            charts[{{ target.id }}] = new Chart(ctx{{ target.id }}, {
                type: 'bar',
                data: {
                    labels: ['CPU', '内存', '磁盘'],
                    datasets: [{
                        label: '使用率 (%)',
                        data: [
                            data{{ target.id }}.cpu || 0,
                            data{{ target.id }}.memory || 0,
                            data{{ target.id }}.disk || 0
                        ],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            // 隐藏加载提示
            const loading = document.getElementById('loading-{{ target.id }}');
            if (loading) {
                loading.style.display = 'none';
            }
            
            console.log('图表 {{ target.id }} 初始化成功');
        } else {
            console.error('找不到canvas元素: chart-{{ target.id }}');
        }
    } catch (e) {
        console.error('初始化图表失败 ({{ target.id }}):', e);
    }
    {% endif %}
    {% endfor %}
}

// 更新统计数据
function updateStats() {
    fetch('/api/dashboard-stats')
        .then(response => response.json())
        .then(data => {
            // 更新统计数字
            document.getElementById('onlineCount').textContent = data.summary.online;
            document.getElementById('offlineCount').textContent = data.summary.offline + data.summary.warning;
            
            // 更新服务器图表
            data.servers.forEach(server => {
                if (charts[server.id]) {
                    try {
                        const metrics = typeof server.data === 'string' ? JSON.parse(server.data) : server.data;
                        charts[server.id].data.datasets[0].data = [
                            metrics.cpu || 0,
                            metrics.memory || 0,
                            metrics.disk || 0
                        ];
                        charts[server.id].update();
                    } catch (e) {
                        console.error('更新图表失败:', e);
                    }
                }
            });
            
            // 更新应用列表
            updateApplicationList(data.applications);
            
            // 更新数据库列表
            updateDatabaseList(data.databases);
            
            // 更新业务指标列表
            updateBusinessMetricsList(data.business);
            
            // 更新备份文件列表
            updateBackupFilesList(data.backups || []);
        })
        .catch(error => console.error('更新统计失败:', error));
}

// 更新应用列表
function updateApplicationList(applications) {
    const listElement = document.getElementById('applicationList');
    if (!listElement) return;
    
    if (applications.length === 0) {
        listElement.innerHTML = '<div class="list-group-item text-muted text-center">暂无应用监控</div>';
        return;
    }
    
    // 获取当前时间
    const currentTime = new Date().toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    
    listElement.innerHTML = '';
    applications.forEach(app => {
        const statusClass = app.status === 'normal' ? 'bg-success' : 'bg-danger';
        const statusText = app.status === 'normal' ? '在线' : '离线';
        
        // 解析数据获取execution_time
        let appData = {};
        try {
            appData = typeof app.data === 'string' ? JSON.parse(app.data) : app.data;
        } catch (e) {
            console.error('解析应用数据失败:', e);
        }
        
        const executionTime = appData.execution_time ? appData.execution_time.toFixed(2) : '0.00';
        
        const item = document.createElement('div');
        item.className = 'list-group-item';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>${app.name}</strong>
                <span class="badge ${statusClass}">${statusText}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">${currentTime}</small>
                <small class="text-muted">
                    <i class="bi bi-stopwatch"></i> 耗时: ${executionTime}秒
                </small>
            </div>
        `;
        listElement.appendChild(item);
    });
}

// 更新数据库列表
function updateDatabaseList(databases) {
    const listElement = document.getElementById('databaseList');
    if (!listElement) return;
    
    if (databases.length === 0) {
        listElement.innerHTML = '<div class="list-group-item text-muted text-center">暂无数据库监控</div>';
        return;
    }
    
    // 获取当前时间
    const currentTime = new Date().toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    
    listElement.innerHTML = '';
    databases.forEach(db => {
        const statusClass = db.status === 'normal' ? 'bg-success' : 'bg-danger';
        const statusText = db.status === 'normal' ? '在线' : '离线';
        
        // 解析数据库数据获取execution_time
        let dbData = {};
        try {
            dbData = typeof db.data === 'string' ? JSON.parse(db.data) : db.data;
        } catch (e) {
            console.error('解析数据库数据失败:', e);
        }
        
        const executionTime = dbData.execution_time ? dbData.execution_time.toFixed(2) : '0.00';
        
        const item = document.createElement('div');
        item.className = 'list-group-item';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>${db.name}</strong>
                <span class="badge ${statusClass}">${statusText}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">${currentTime}</small>
                <small class="text-muted">
                    <i class="bi bi-stopwatch"></i> 耗时: ${executionTime}秒
                </small>
            </div>
        `;
        listElement.appendChild(item);
    });
}

// 更新业务指标列表
function updateBusinessMetricsList(business) {
    console.log('更新业务指标列表，数据:', business);
    const listElement = document.getElementById('businessMetricsList');
    if (!listElement) {
        console.error('businessMetricsList 元素未找到');
        return;
    }
    
    if (business.length === 0) {
        listElement.innerHTML = '<div class="col-12"><div class="text-muted text-center py-3">暂无业务指标监控</div></div>';
        return;
    }
    
    // 获取当前时间
    const currentTime = new Date().toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    
    listElement.innerHTML = '';
    business.forEach(biz => {
        try {
            console.log('处理业务指标:', biz.name);
            let statusClass = 'secondary';
            let statusText = '未知';
            
            if (biz.status === 'normal') {
                statusClass = 'success';
                statusText = '正常';
            } else if (biz.status === 'warning') {
                statusClass = 'warning';
                statusText = '告警';
            } else {
                statusClass = 'danger';
                statusText = '异常';
            }
            
            // 解析数据
            let metricData = {};
            try {
                metricData = typeof biz.data === 'string' ? JSON.parse(biz.data) : biz.data;
                console.log('解析后的数据:', metricData);
            } catch (e) {
                console.error('解析业务指标数据失败:', e, '原始数据:', biz.data);
                return;
            }
            
            // 构建详细数据HTML
            let detailHtml = '';
            const dataToShow = metricData.all_data || metricData.detail_data;
            
            if (dataToShow && dataToShow.length > 0) {
                console.log('显示数据，条数:', dataToShow.length);
                const alertClass = metricData.alert ? 'alert alert-warning' : 'border rounded p-2';
                const title = metricData.alert ? '异常记录（前5条）：' : '查询结果（前5条）：';
                const recordCount = metricData.row_count ? `<small class="text-muted ms-2">共 ${metricData.row_count} 条记录</small>` : '';
                
                detailHtml = `
                    <div class="${alertClass} mb-0">
                        <strong>${title}</strong>${recordCount}
                        <div style="font-family: monospace; font-size: 0.85em; margin-top: 10px; max-height: 150px; overflow-y: auto;">
                `;
                
                dataToShow.slice(0, 5).forEach((row, index) => {
                    detailHtml += `<div class="mb-1">[${index + 1}] ${row.join(', ')}</div>`;
                });
                
                if (metricData.row_count > 5) {
                    detailHtml += `<div class="text-muted mt-2">... 还有 ${metricData.row_count - 5} 条记录</div>`;
                }
                
                detailHtml += `</div></div>`;
            }
            
            const item = document.createElement('div');
            item.className = 'col-md-6 mb-3';
            item.innerHTML = `
                <div class="card border-${statusClass === 'warning' ? 'warning' : 'secondary'}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>${biz.name}</strong>
                        <span class="badge bg-${statusClass}">${statusText}</span>
                    </div>
                    <div class="card-body">
                        ${detailHtml}
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> ${currentTime}
                            </small>
                        </div>
                    </div>
                </div>
            `;
            listElement.appendChild(item);
            console.log('业务指标卡片已添加:', biz.name);
        } catch (e) {
            console.error('处理业务指标失败:', biz.name, e);
        }
    });
    console.log('业务指标列表更新完成');
}

// 更新备份文件列表
function updateBackupFilesList(backups) {
    console.log('更新备份文件列表，数据:', backups);
    const listElement = document.getElementById('backupFilesList');
    if (!listElement) {
        console.error('backupFilesList 元素未找到');
        return;
    }
    
    if (backups.length === 0) {
        listElement.innerHTML = '<div class="col-12"><div class="text-muted text-center py-3">暂无备份文件监控</div></div>';
        return;
    }
    
    // 获取当前时间
    const currentTime = new Date().toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    
    listElement.innerHTML = '';
    backups.forEach(backup => {
        try {
            console.log('处理备份监控:', backup.name);
            let statusClass = 'secondary';
            let statusText = '未知';
            let borderClass = 'secondary';
            
            if (backup.status === 'normal') {
                statusClass = 'success';
                statusText = '正常';
                borderClass = 'secondary';
            } else if (backup.status === 'warning') {
                statusClass = 'warning';
                statusText = '告警';
                borderClass = 'warning';
            } else {
                statusClass = 'danger';
                statusText = '异常';
                borderClass = 'danger';
            }
            
            // 解析数据
            let backupData = {};
            try {
                backupData = typeof backup.data === 'string' ? JSON.parse(backup.data) : backup.data;
                console.log('解析后的备份数据:', backupData);
            } catch (e) {
                console.error('解析备份数据失败:', e, '原始数据:', backup.data);
                return;
            }
            
            // 构建告警信息HTML
            let alertHtml = '';
            if (backupData.alert && backupData.alert_message) {
                alertHtml = `
                    <div class="alert alert-warning mb-2">
                        <i class="bi bi-exclamation-triangle"></i> ${backupData.alert_message}
                    </div>
                `;
            }
            
            // 构建文件列表HTML
            let filesHtml = '';
            if (backupData.files && backupData.files.length > 0) {
                filesHtml = `
                    <div class="border rounded p-2">
                        <strong>最新备份文件（前5个）：</strong>
                        <div style="font-family: monospace; font-size: 0.85em; margin-top: 10px; max-height: 150px; overflow-y: auto;">
                `;
                
                backupData.files.slice(0, 5).forEach(file => {
                    filesHtml += `
                        <div class="mb-1 d-flex justify-content-between">
                            <span class="text-truncate" style="max-width: 60%;">${file.name}</span>
                            <span class="text-muted">${file.size_human} | ${file.mtime_str}</span>
                        </div>
                    `;
                });
                
                filesHtml += `</div></div>`;
            }
            
            const item = document.createElement('div');
            item.className = 'col-md-6 mb-3';
            item.innerHTML = `
                <div class="card border-${borderClass}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>${backup.name}</strong>
                        <span class="badge bg-${statusClass}">${statusText}</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="bi bi-folder"></i> 备份目录:</span>
                                <code>${backupData.backup_path || 'N/A'}</code>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="bi bi-file-earmark"></i> 文件数量:</span>
                                <strong>${backupData.total_count || 0}</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span><i class="bi bi-hdd"></i> 总大小:</span>
                                <strong>${backupData.total_size_human || '0 B'}</strong>
                            </div>
                        </div>
                        ${alertHtml}
                        ${filesHtml}
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> ${currentTime}
                            </small>
                        </div>
                    </div>
                </div>
            `;
            listElement.appendChild(item);
            console.log('备份监控卡片已添加:', backup.name);
        } catch (e) {
            console.error('处理备份监控失败:', backup.name, e);
        }
    });
    console.log('备份文件列表更新完成');
}

// 刷新仪表板（局部刷新，不重载整个页面）
let isRefreshing = false; // 防止重复刷新

function refreshDashboard() {
    console.log('refreshDashboard函数被调用');
    
    // 如果正在刷新，忽略此次调用
    if (isRefreshing) {
        console.log('已在刷新中，忽略此次调用');
        return;
    }
    
    const button = document.getElementById('refreshBtn');
    if (!button) {
        console.error('刷新按钮未找到');
        return;
    }
    
    console.log('找到刷新按钮，开始刷新...');
    
    isRefreshing = true;
    const originalText = button.innerHTML;
    
    // 显示加载状态
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-arrow-clockwise rotating"></i> 触发监控检查中...';
    
    console.log('触发监控检查...');
    
    // 先触发监控检查
    fetch('/api/trigger-check', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(checkResult => {
        console.log('监控检查完成:', checkResult);
        
        if (!checkResult.success) {
            throw new Error(checkResult.error || '监控检查失败');
        }
        
        // 显示监控检查结果
        button.innerHTML = '<i class="bi bi-arrow-clockwise rotating"></i> 刷新数据中...';
        
        // 等待1秒让数据写入数据库
        return new Promise(resolve => setTimeout(resolve, 1000));
    })
    .then(() => {
        console.log('开始刷新数据...');
        
        // 更新统计数据
        return fetch('/api/dashboard-stats');
    })
        .then(response => response.json())
        .then(data => {
            console.log('收到数据:', data);
            
            // 更新统计数字
            document.getElementById('onlineCount').textContent = data.summary.online;
            document.getElementById('offlineCount').textContent = data.summary.offline + data.summary.warning;
            
            // 更新服务器图表
            console.log('更新服务器图表，数量:', data.servers.length);
            const currentTime = new Date().toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            data.servers.forEach(server => {
                console.log('处理服务器:', server.id, '数据:', server.data);
                if (charts[server.id]) {
                    try {
                        // 数据可能已经是对象，也可能是字符串
                        let metrics;
                        if (typeof server.data === 'string') {
                            metrics = JSON.parse(server.data);
                        } else {
                            metrics = server.data;
                        }
                        
                        console.log('解析后的指标:', metrics);
                        
                        charts[server.id].data.datasets[0].data = [
                            metrics.cpu || 0,
                            metrics.memory || 0,
                            metrics.disk || 0
                        ];
                        charts[server.id].update();
                        
                        // 更新时间显示
                        const timeElement = document.getElementById(`update-time-${server.id}`);
                        if (timeElement) {
                            timeElement.textContent = `最后更新: ${currentTime}`;
                        }
                        
                        console.log('图表', server.id, '更新成功');
                    } catch (e) {
                        console.error('更新图表失败:', server.id, e);
                    }
                } else {
                    console.warn('图表不存在:', server.id);
                }
            });
            
            // 更新应用列表
            try {
                updateApplicationList(data.applications);
            } catch (e) {
                console.error('更新应用列表失败:', e);
            }
            
            // 更新数据库列表
            try {
                updateDatabaseList(data.databases);
            } catch (e) {
                console.error('更新数据库列表失败:', e);
            }
            
            // 更新业务指标列表
            try {
                updateBusinessMetricsList(data.business);
            } catch (e) {
                console.error('更新业务指标列表失败:', e);
            }
            
            // 更新备份文件列表
            try {
                updateBackupFilesList(data.backups || []);
            } catch (e) {
                console.error('更新备份文件列表失败:', e);
            }
            
            // 恢复按钮状态
            console.log('恢复按钮状态');
            button.disabled = false;
            button.innerHTML = originalText;
            isRefreshing = false;
            
            // 显示刷新成功提示
            console.log('显示刷新成功提示');
            showToast('数据已更新');
        })
        .catch(error => {
            console.error('刷新失败:', error);
            button.disabled = false;
            button.innerHTML = originalText;
            isRefreshing = false;
            showToast('刷新失败，请重试', 'error');
        });
}

// 显示提示消息
function showToast(message, type = 'success') {
    // 创建提示元素
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.textContent = message;
    
    const bgColor = type === 'success' ? '#28a745' : '#dc3545';
    toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${bgColor};
        color: white;
        padding: 12px 24px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 9999;
        animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(toast);
    
    // 3秒后移除
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// 添加动画样式
const style = document.createElement('style');
style.textContent = `
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .rotating {
        display: inline-block;
        animation: rotate 1s linear infinite;
    }
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    /* 拖拽样式 */
    .sortable-ghost {
        opacity: 0.4;
        background: #f8f9fa;
    }
    .sortable-chosen {
        cursor: move;
    }
    .sortable-drag {
        opacity: 0.8;
    }
    .draggable-item {
        transition: transform 0.2s ease;
    }
    .draggable-item:hover .card {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .card-header[style*="cursor: move"]:hover {
        background-color: #f8f9fa;
    }
`;
document.head.appendChild(style);

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('仪表板页面加载完成');
    
    // 检查Chart.js是否加载
    if (typeof Chart === 'undefined') {
        console.error('Chart.js未加载！');
        alert('图表库加载失败，请刷新页面重试');
        return;
    }
    console.log('Chart.js已加载，版本:', Chart.version);
    
    // 先恢复布局
    restoreDashboardLayout();
    
    // 初始化图表
    initServerCharts();
    updateStats();
    
    // 初始化拖拽功能
    initDragAndDrop();
    
    // 绑定刷新按钮事件
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
        console.log('刷新按钮找到，绑定事件');
        refreshBtn.addEventListener('click', refreshDashboard);
    } else {
        console.error('刷新按钮未找到');
    }
    
    // 获取系统配置的检查间隔，并设置自动刷新
    fetch('/api/config')
        .then(response => response.json())
        .then(config => {
            const checkInterval = parseInt(config.check_interval || 600); // 默认600秒
            const refreshIntervalMs = checkInterval * 1000; // 转换为毫秒
            
            // 更新显示的刷新间隔
            const refreshIntervalSpan = document.getElementById('refreshInterval');
            if (refreshIntervalSpan) {
                refreshIntervalSpan.textContent = checkInterval;
            }
            
            console.log(`设置自动刷新间隔: ${checkInterval}秒`);
            
            // 设置自动刷新
            setInterval(updateStats, refreshIntervalMs);
        })
        .catch(error => {
            console.error('获取配置失败，使用默认30秒刷新:', error);
            // 如果获取配置失败，使用默认30秒
            const refreshIntervalSpan = document.getElementById('refreshInterval');
            if (refreshIntervalSpan) {
                refreshIntervalSpan.textContent = '30';
            }
            setInterval(updateStats, 30000);
        });
});
</script>
{% endblock %}

# 用户权限管理说明

## 概述

系统支持多用户管理和基于角色的权限控制，分为管理员和普通用户两种角色。

## 用户角色

### 管理员（Admin）
- 拥有系统的完全控制权限
- 可以添加、编辑、删除监控目标
- 可以修改系统配置
- 可以管理用户（添加、编辑、删除用户）
- 可以查看所有监控数据和告警记录

### 普通用户（User）
- 只读权限，只能查看监控数据
- 可以访问监控仪表板
- 可以查看监控目标列表
- 可以查看告警记录
- 可以查看系统配置
- **不能**添加、编辑、删除监控目标
- **不能**修改系统配置
- **不能**管理其他用户
- 可以修改自己的密码

## 默认管理员账户

系统初始化时会自动创建默认管理员账户：

- **用户名**: admin
- **密码**: admin123
- **角色**: 管理员

⚠️ **重要**: 首次登录后请立即修改默认密码！

## 用户管理

### 添加用户

1. 使用管理员账户登录系统
2. 点击左侧菜单的"用户管理"
3. 点击"添加用户"按钮
4. 填写用户信息：
   - 用户名（必填）：用于登录的用户名
   - 邮箱（可选）：用户的邮箱地址
   - 密码（必填）：至少6位字符
   - 管理员权限：勾选则为管理员，不勾选则为普通用户
5. 点击"保存"

### 编辑用户

1. 在用户管理页面找到要编辑的用户
2. 点击"编辑"按钮
3. 修改用户信息
4. 密码字段留空表示不修改密码
5. 点击"保存"

### 删除用户

1. 在用户管理页面找到要删除的用户
2. 点击"删除"按钮
3. 确认删除操作

⚠️ **注意**: 
- 不能删除当前登录的用户
- 删除操作不可恢复

## 权限控制详情

### 页面访问权限

| 功能 | 管理员 | 普通用户 |
|------|--------|----------|
| 监控仪表板 | ✅ | ✅ |
| 监控目标列表 | ✅ | ✅ |
| 添加监控目标 | ✅ | ❌ |
| 编辑监控目标 | ✅ | ❌ |
| 删除监控目标 | ✅ | ❌ |
| 告警记录 | ✅ | ✅ |
| 系统配置查看 | ✅ | ✅ |
| 系统配置修改 | ✅ | ❌ |
| 用户管理 | ✅ | ❌ |
| 修改自己密码 | ✅ | ✅ |

### API权限控制

所有API都需要登录才能访问，部分API需要管理员权限：

- `POST /api/targets` - 添加监控目标（需要管理员）
- `PUT /api/targets/<id>` - 编辑监控目标（需要管理员）
- `DELETE /api/targets/<id>` - 删除监控目标（需要管理员）
- `POST /api/config` - 修改系统配置（需要管理员）
- `/api/users/*` - 所有用户管理API（需要管理员）

## 使用场景

### 场景1：运维团队协作

- **管理员**: 运维主管，负责配置和管理监控目标
- **普通用户**: 运维工程师，查看监控数据和告警信息

### 场景2：跨部门监控

- **管理员**: IT部门负责人，管理所有监控配置
- **普通用户**: 业务部门人员，查看相关业务指标

### 场景3：只读展示

- **管理员**: 系统管理员
- **普通用户**: 大屏展示账户，只用于显示监控仪表板

## 安全建议

1. **定期更换密码**: 建议每3个月更换一次密码
2. **最小权限原则**: 只给需要管理权限的用户分配管理员角色
3. **账户审计**: 定期检查用户列表，删除不再使用的账户
4. **密码强度**: 使用至少8位包含字母、数字和特殊字符的密码
5. **及时删除**: 员工离职时立即删除其账户

## 修改密码

所有用户都可以修改自己的密码：

1. 点击右上角的设置图标（齿轮）
2. 选择"修改密码"
3. 输入原密码
4. 输入新密码（至少6位）
5. 确认新密码
6. 点击"修改密码"
7. 系统会自动退出，使用新密码重新登录

## 常见问题

### Q: 忘记管理员密码怎么办？

A: 可以通过数据库直接重置密码：

```python
# 创建一个重置密码的脚本 reset_admin_password.py
import sqlite3
from werkzeug.security import generate_password_hash

conn = sqlite3.connect('monitoring.db')
cursor = conn.cursor()

# 重置admin用户的密码为 admin123
new_password_hash = generate_password_hash('admin123', method='pbkdf2:sha256')
cursor.execute('UPDATE users SET password_hash = ? WHERE username = ?', 
               (new_password_hash, 'admin'))
conn.commit()
conn.close()

print('管理员密码已重置为: admin123')
```

运行脚本：
```bash
python3 reset_admin_password.py
```

### Q: 如何批量导入用户？

A: 可以编写脚本批量创建用户：

```python
import sqlite3
from werkzeug.security import generate_password_hash

users = [
    ('user1', 'password1', 'user1@example.com', 0),
    ('user2', 'password2', 'user2@example.com', 0),
    # ... 更多用户
]

conn = sqlite3.connect('monitoring.db')
cursor = conn.cursor()

for username, password, email, is_admin in users:
    password_hash = generate_password_hash(password, method='pbkdf2:sha256')
    cursor.execute('''
        INSERT INTO users (username, password_hash, email, is_admin)
        VALUES (?, ?, ?, ?)
    ''', (username, password_hash, email, is_admin))

conn.commit()
conn.close()
```

### Q: 普通用户能看到其他用户的信息吗？

A: 不能。普通用户无法访问用户管理页面，也无法调用用户管理相关的API。

### Q: 可以设置更细粒度的权限吗？

A: 当前版本只支持管理员和普通用户两种角色。如需更细粒度的权限控制（如只能管理特定类型的监控目标），需要扩展权限系统。

## 技术实现

### 权限装饰器

系统使用两个装饰器实现权限控制：

1. `@login_required`: 要求用户必须登录
2. `@admin_required`: 要求用户必须是管理员

### Session管理

- 用户登录后，用户信息存储在session中
- Session包含：user_id, username, is_admin
- 支持"记住我"功能，最长30天

### 前端权限控制

- 使用Jinja2模板的条件判断隐藏/显示按钮
- 根据`session.is_admin`判断用户权限
- 禁用普通用户的表单输入

### 后端权限控制

- API层面验证用户权限
- 返回403错误或错误消息
- 防止绕过前端限制直接调用API

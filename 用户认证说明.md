# 用户认证功能说明

## 功能概述

系统已实现完整的用户认证功能，所有页面和API都需要登录后才能访问，有效保护系统安全。

## 默认账户

首次启动系统时，会自动创建默认管理员账户：

- **用户名**: `admin`
- **密码**: `admin123`
- **权限**: 管理员

⚠️ **重要**：首次登录后请立即修改密码！

## 功能特性

### 1. 登录功能
- 用户名密码登录
- "记住我"功能（30天免登录）
- 登录失败提示
- 自动重定向到原访问页面

### 2. 会话管理
- 安全的session加密
- 可配置的session过期时间
- 自动登出机制

### 3. 密码安全
- 使用PBKDF2-SHA256哈希算法
- 密码不以明文存储
- 支持在线修改密码
- 密码长度至少6位

### 4. 访问控制
- 所有页面需要登录
- 所有API需要认证
- 管理员权限预留（可扩展）

## 使用说明

### 首次登录

1. 启动系统后访问 http://localhost:8080
2. 自动跳转到登录页面
3. 使用默认账户登录：
   - 用户名：`admin`
   - 密码：`admin123`
4. 登录成功后立即修改密码

### 修改密码

1. 登录后点击右上角用户菜单
2. 选择"修改密码"
3. 输入原密码和新密码
4. 确认后会自动退出，需要用新密码重新登录

### 退出登录

1. 点击右上角用户菜单
2. 选择"退出登录"
3. 自动跳转到登录页面

## 安全建议

### 1. 密码安全
- ✅ 首次登录后立即修改默认密码
- ✅ 使用强密码（字母+数字+特殊字符）
- ✅ 定期更换密码
- ✅ 不要与他人共享密码

### 2. 会话安全
- ✅ 使用完毕后及时退出登录
- ✅ 不要在公共电脑上勾选"记住我"
- ✅ 定期清理浏览器Cookie

### 3. 系统安全
- ✅ 修改SECRET_KEY（生产环境）
- ✅ 使用HTTPS加密传输
- ✅ 限制访问IP（防火墙）
- ✅ 定期检查登录日志

## 技术实现

### 密码哈希
```python
# 使用PBKDF2-SHA256算法
from werkzeug.security import generate_password_hash, check_password_hash

# 生成密码哈希
password_hash = generate_password_hash('password', method='pbkdf2:sha256')

# 验证密码
is_valid = check_password_hash(password_hash, 'password')
```

### Session配置
```python
# Flask session配置
app.secret_key = Config.SECRET_KEY  # 用于session加密

# 记住我功能（30天）
session.permanent = True
app.permanent_session_lifetime = timedelta(days=30)
```

### 登录装饰器
```python
from functools import wraps

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('login', next=request.url))
        return f(*args, **kwargs)
    return decorated_function
```

## 数据库结构

### users表
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    email TEXT,
    is_admin INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP
);
```

## 扩展功能（未来）

### 1. 多用户管理
- 用户注册功能
- 用户列表管理
- 用户权限管理
- 用户启用/禁用

### 2. 角色权限
- 管理员角色
- 普通用户角色
- 只读用户角色
- 自定义角色

### 3. 审计日志
- 登录日志
- 操作日志
- 异常登录检测
- 登录IP记录

### 4. 高级安全
- 双因素认证（2FA）
- 密码复杂度要求
- 密码过期策略
- 登录失败锁定

### 5. 单点登录（SSO）
- LDAP集成
- OAuth2支持
- SAML支持

## 常见问题

### Q: 忘记密码怎么办？
A: 目前需要直接修改数据库。可以使用以下Python脚本重置密码：

```python
import sqlite3
from werkzeug.security import generate_password_hash

conn = sqlite3.connect('monitoring.db')
cursor = conn.cursor()

# 重置admin密码为admin123
new_hash = generate_password_hash('admin123', method='pbkdf2:sha256')
cursor.execute('UPDATE users SET password_hash = ? WHERE username = ?', 
               (new_hash, 'admin'))
conn.commit()
conn.close()

print("密码已重置为: admin123")
```

### Q: 如何添加新用户？
A: 目前需要直接操作数据库。未来版本会添加用户管理界面。

```python
import sqlite3
from werkzeug.security import generate_password_hash

conn = sqlite3.connect('monitoring.db')
cursor = conn.cursor()

username = 'newuser'
password = 'password123'
password_hash = generate_password_hash(password, method='pbkdf2:sha256')

cursor.execute('''
    INSERT INTO users (username, password_hash, email, is_admin)
    VALUES (?, ?, ?, ?)
''', (username, password_hash, 'user@example.com', 0))

conn.commit()
conn.close()

print(f"用户 {username} 已创建")
```

### Q: 如何修改SECRET_KEY？
A: 在config.py中修改或设置环境变量：

```bash
# 方法1：修改config.py
SECRET_KEY = 'your-secret-key-here'

# 方法2：设置环境变量
export SECRET_KEY='your-secret-key-here'
```

### Q: Session过期时间如何调整？
A: 修改app.py中的配置：

```python
# 修改记住我的过期时间（默认30天）
app.permanent_session_lifetime = timedelta(days=7)  # 改为7天
```

## 安全检查清单

部署到生产环境前，请确保：

- [ ] 已修改默认管理员密码
- [ ] 已设置强SECRET_KEY
- [ ] 已启用HTTPS
- [ ] 已配置防火墙
- [ ] 已限制访问IP
- [ ] 已定期备份数据库
- [ ] 已设置合理的session过期时间
- [ ] 已禁用debug模式

---

**最后更新**: 2026-01-21
**版本**: 1.0

# 时区配置说明

## 问题说明

系统默认使用 SQLite 数据库，其 `CURRENT_TIMESTAMP` 函数返回的是 **UTC 时间**（协调世界时），而不是本地时间。这会导致显示的时间与实际本地时间不一致。

例如：
- 中国标准时间（CST）= UTC + 8小时
- 如果当前北京时间是 16:30，数据库中存储的是 08:30（UTC时间）

## 已实现的解决方案

系统现在会自动将 UTC 时间转换为本地时区时间进行显示。

### 1. 自动时区转换

所有页面显示的时间都会自动转换为本地时区：
- 监控仪表板
- 监控目标列表
- 告警记录
- 监控详情页面
- API 返回的数据

### 2. 默认时区

系统默认使用 **中国标准时间（Asia/Shanghai，UTC+8）**

### 3. 时区配置

可以在"系统配置"页面修改时区设置：

访问：http://localhost:8080/config

支持的时区：
- **中国标准时间** (Asia/Shanghai) - UTC+8
- **日本标准时间** (Asia/Tokyo) - UTC+9
- **香港时间** (Asia/Hong_Kong) - UTC+8
- **新加坡时间** (Asia/Singapore) - UTC+8
- **协调世界时** (UTC) - UTC+0
- **美国东部时间** (America/New_York) - UTC-5
- **美国西部时间** (America/Los_Angeles) - UTC-8
- **英国时间** (Europe/London) - UTC+0

### 4. 相对时间显示

部分页面还会显示相对时间，如：
- "5分钟前"
- "2小时前"
- "1天前"

## 使用方法

### 查看当前时区

系统默认使用中国标准时间（UTC+8）

### 修改时区

1. 访问"系统配置"页面
2. 找到"时区设置"下拉框
3. 选择你所在的时区
4. 点击"保存配置"
5. 刷新页面查看效果

### 通过环境变量设置

也可以通过环境变量设置时区：

```bash
export TIMEZONE=Asia/Shanghai
python3 app.py
```

## 时区列表

### 亚洲时区
- `Asia/Shanghai` - 中国标准时间 (UTC+8)
- `Asia/Hong_Kong` - 香港时间 (UTC+8)
- `Asia/Tokyo` - 日本标准时间 (UTC+9)
- `Asia/Seoul` - 韩国标准时间 (UTC+9)
- `Asia/Singapore` - 新加坡时间 (UTC+8)
- `Asia/Bangkok` - 泰国时间 (UTC+7)
- `Asia/Dubai` - 迪拜时间 (UTC+4)
- `Asia/Kolkata` - 印度标准时间 (UTC+5:30)

### 欧洲时区
- `Europe/London` - 英国时间 (UTC+0/+1)
- `Europe/Paris` - 中欧时间 (UTC+1/+2)
- `Europe/Berlin` - 德国时间 (UTC+1/+2)
- `Europe/Moscow` - 莫斯科时间 (UTC+3)

### 美洲时区
- `America/New_York` - 美国东部时间 (UTC-5/-4)
- `America/Chicago` - 美国中部时间 (UTC-6/-5)
- `America/Denver` - 美国山地时间 (UTC-7/-6)
- `America/Los_Angeles` - 美国西部时间 (UTC-8/-7)
- `America/Sao_Paulo` - 巴西时间 (UTC-3)

### 其他时区
- `UTC` - 协调世界时 (UTC+0)
- `Australia/Sydney` - 悉尼时间 (UTC+10/+11)
- `Pacific/Auckland` - 新西兰时间 (UTC+12/+13)

## 技术细节

### 时间存储

- 数据库中存储的是 **UTC 时间**
- 这是最佳实践，便于跨时区使用

### 时间显示

- 前端显示时自动转换为本地时区
- 使用 Python `pytz` 库进行时区转换

### 时间格式

- 标准格式：`2026-01-19 16:30:00`
- 相对时间：`5分钟前`、`2小时前`

## 常见问题

### Q1: 为什么时间显示不对？

**可能原因：**
1. 时区设置不正确
2. 浏览器缓存问题
3. 服务器时间不准确

**解决方法：**
1. 检查系统配置中的时区设置
2. 清除浏览器缓存并刷新
3. 检查服务器系统时间：`date`

### Q2: 如何验证时区设置？

在浏览器控制台输入：
```javascript
new Date().toString()
```

这会显示浏览器的本地时间和时区。

### Q3: 数据库中的时间是什么时区？

数据库中存储的是 **UTC 时间**，这是标准做法。系统会在显示时自动转换为你设置的时区。

### Q4: 修改时区后历史数据会变吗？

不会。历史数据在数据库中以 UTC 时间存储，修改时区只影响显示，不影响存储的数据。

### Q5: 如何添加新的时区？

编辑 `templates/config.html`，在时区下拉框中添加新选项：

```html
<option value="Your/Timezone">时区名称 (UTC±X)</option>
```

时区名称必须是有效的 IANA 时区标识符。

## 验证时区转换

### 方法1：查看监控数据

1. 访问监控目标页面
2. 查看"创建时间"列
3. 确认时间是否为本地时间

### 方法2：查看告警记录

1. 访问告警记录页面
2. 查看告警时间
3. 确认是否为本地时间

### 方法3：使用 Python 测试

```python
from utils import utc_to_local, get_local_time

# 测试 UTC 转本地时间
utc_time = "2026-01-19 08:30:00"
local_time = utc_to_local(utc_time)
print(f"UTC: {utc_time}")
print(f"本地: {local_time}")

# 获取当前本地时间
current = get_local_time()
print(f"当前本地时间: {current}")
```

## 最佳实践

1. **统一使用 UTC 存储**：数据库中始终存储 UTC 时间
2. **显示时转换**：在前端显示时转换为用户时区
3. **记录时区信息**：在日志中记录使用的时区
4. **测试多时区**：如果有跨时区用户，测试不同时区的显示

---

**注意**：修改时区设置后，建议刷新页面以确保所有时间都正确显示。

# 连接测试功能说明

## 功能概述

在添加或编辑监控目标时，现在可以在保存前测试连接，验证配置是否正确。这可以避免保存错误的配置，提高配置效率。

## 使用方法

### 在添加监控目标时测试

1. 点击"添加监控目标"按钮
2. 填写监控目标的配置信息
3. 点击"测试连接"按钮（蓝色按钮）
4. 等待测试结果
5. 如果测试成功，点击"保存"
6. 如果测试失败，根据错误提示修改配置

### 在编辑监控目标时测试

1. 点击监控目标的"编辑"按钮
2. 修改配置信息
3. 点击"测试连接"按钮
4. 等待测试结果
5. 如果测试成功，点击"保存修改"

## 支持的监控类型

### 1. 服务器监控

#### 本地服务器
**测试内容：**
- 检查本地系统是否可访问
- 获取 CPU 使用率
- 获取内存使用率

**成功示例：**
```
✓ 本地服务器连接正常！

详细信息：
  cpu: 15.23%
  memory: 45.67%
```

#### 远程服务器
**测试内容：**
- SSH 连接测试
- 获取主机名
- 获取操作系统信息
- 获取 CPU 使用率
- 获取内存使用率

**成功示例：**
```
✓ 连接成功！

详细信息：
  hostname: web-server-01
  os: Ubuntu 20.04.3 LTS
  cpu: 23.45%
  memory: 56.78%
```

**失败示例：**
```
✗ 无法连接到远程服务器，请检查地址、端口、用户名和密码/密钥
```

**常见错误：**
- 地址或端口错误
- 用户名或密码错误
- SSH 密钥路径错误或权限问题
- 防火墙阻止连接
- 目标服务器 SSH 服务未运行

### 2. 应用监控

**测试内容：**
- HTTP/HTTPS 请求测试
- 获取响应状态码
- 测量响应时间

**成功示例：**
```
✓ 应用连接成功！状态码: 200

详细信息：
  status_code: 200
  response_time: 0.15秒
```

**失败示例：**
```
✗ 测试失败: HTTPConnectionPool(host='example.com', port=80): 
Max retries exceeded with url: /
```

**常见错误：**
- URL 格式错误
- 域名无法解析
- 服务器不可达
- 连接超时
- SSL 证书问题

### 3. 数据库监控

**测试内容：**
- MySQL 连接测试
- 获取数据库版本

**成功示例：**
```
✓ 数据库连接成功！

详细信息：
  version: 8.0.27
```

**失败示例：**
```
✗ 测试失败: (2003, "Can't connect to MySQL server on '192.168.1.100' (111)")
```

**常见错误：**
- 主机地址或端口错误
- 用户名或密码错误
- 数据库不存在
- 用户权限不足
- MySQL 服务未运行
- 防火墙阻止连接

### 4. 存储监控

**测试内容：**
- 检查路径是否存在
- 获取存储容量信息

**成功示例：**
```
✓ 存储路径有效！

详细信息：
  total: 500.00 GB
  used: 250.50 GB
  free: 249.50 GB
  percent: 50.1%
```

**失败示例：**
```
✗ 路径不存在: /data/backup
```

**常见错误：**
- 路径不存在
- 路径权限不足
- 路径格式错误

### 5. 业务指标监控

**测试内容：**
- 数据库连接测试
- SQL 查询执行测试
- 获取查询结果

**成功示例：**
```
✓ SQL 查询执行成功！

详细信息：
  result: 1234
```

**失败示例：**
```
✗ 测试失败: (1146, "Table 'mydb.orders' doesn't exist")
```

**常见错误：**
- 数据库连接失败
- SQL 语法错误
- 表或字段不存在
- 查询权限不足
- 查询超时

## 测试流程

```
┌─────────────────┐
│  填写配置信息    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  点击测试连接    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  显示加载状态    │
│  (测试中...)     │
└────────┬────────┘
         │
         ▼
    ┌────┴────┐
    │  测试   │
    └────┬────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌───────┐ ┌───────┐
│ 成功  │ │ 失败  │
└───┬───┘ └───┬───┘
    │         │
    ▼         ▼
┌───────┐ ┌───────┐
│显示详情│ │显示错误│
└───┬───┘ └───┬───┘
    │         │
    ▼         ▼
┌───────┐ ┌───────┐
│ 保存  │ │修改配置│
└───────┘ └───────┘
```

## 最佳实践

### 1. 测试顺序
建议按以下顺序测试：
1. 先测试基本连接（如 SSH、HTTP、数据库连接）
2. 再测试具体功能（如 SQL 查询）
3. 确认所有测试通过后再保存

### 2. 错误处理
- 仔细阅读错误信息
- 根据错误提示修改配置
- 多次测试直到成功
- 如果持续失败，检查网络和服务状态

### 3. 安全建议
- 不要在测试时使用生产环境的敏感数据
- 测试完成后及时保存配置
- 定期更新密码和密钥

### 4. 性能考虑
- 测试可能需要几秒到十几秒
- 不要频繁点击测试按钮
- 如果测试超时，检查网络连接

## 故障排查

### 问题1：测试按钮无反应

**可能原因：**
- JavaScript 错误
- 网络连接问题
- 浏览器兼容性问题

**解决方法：**
1. 打开浏览器控制台（F12）查看错误
2. 刷新页面重试
3. 检查网络连接
4. 尝试其他浏览器

### 问题2：测试一直显示"测试中..."

**可能原因：**
- 服务器响应超时
- 网络连接中断
- 后端服务异常

**解决方法：**
1. 等待更长时间（最多30秒）
2. 刷新页面重试
3. 检查服务器日志
4. 检查网络连接

### 问题3：测试成功但保存后监控失败

**可能原因：**
- 配置在保存时被修改
- 服务器状态变化
- 权限问题

**解决方法：**
1. 重新编辑并测试
2. 检查监控日志
3. 验证配置是否正确保存

### 问题4：远程服务器测试失败

**检查清单：**
- [ ] IP 地址是否正确
- [ ] SSH 端口是否正确（默认22）
- [ ] 用户名是否正确
- [ ] 密码/密钥是否正确
- [ ] 目标服务器 SSH 服务是否运行
- [ ] 防火墙是否允许连接
- [ ] 网络是否通畅（ping 测试）

### 问题5：数据库测试失败

**检查清单：**
- [ ] 主机地址是否正确
- [ ] 端口是否正确（MySQL 默认3306）
- [ ] 用户名是否正确
- [ ] 密码是否正确
- [ ] 数据库名是否存在
- [ ] 用户是否有连接权限
- [ ] MySQL 服务是否运行
- [ ] 防火墙是否允许连接

## 技术细节

### API 端点
```
POST /api/test-connection
```

### 请求格式
```json
{
  "type": "server|application|database|storage|business",
  "config": {
    // 根据类型不同，配置字段不同
  }
}
```

### 响应格式

**成功：**
```json
{
  "success": true,
  "message": "连接成功！",
  "details": {
    "key1": "value1",
    "key2": "value2"
  }
}
```

**失败：**
```json
{
  "success": false,
  "message": "错误描述"
}
```

### 超时设置
- SSH 连接：10秒
- HTTP 请求：10秒
- 数据库连接：10秒

## 示例场景

### 场景1：添加远程服务器

```
1. 填写配置：
   - 服务器地址: 192.168.1.100
   - SSH端口: 22
   - 用户名: root
   - 密码: ********

2. 点击"测试连接"

3. 测试结果：
   ✓ 连接成功！
   hostname: web-server-01
   os: Ubuntu 20.04.3 LTS
   cpu: 15.23%
   memory: 45.67%

4. 点击"保存"
```

### 场景2：添加应用监控

```
1. 填写配置：
   - URL: https://www.example.com

2. 点击"测试连接"

3. 测试结果：
   ✓ 应用连接成功！状态码: 200
   status_code: 200
   response_time: 0.25秒

4. 点击"保存"
```

### 场景3：添加数据库监控

```
1. 填写配置：
   - 主机地址: 192.168.1.100
   - 端口: 3306
   - 用户名: monitor
   - 密码: ********
   - 数据库名: mydb

2. 点击"测试连接"

3. 测试结果：
   ✓ 数据库连接成功！
   version: 8.0.27

4. 点击"保存"
```

---

**提示**：测试连接功能可以大大减少配置错误，建议每次添加或修改监控目标时都使用此功能！

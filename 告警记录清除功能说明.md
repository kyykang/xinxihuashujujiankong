# 告警记录清除功能说明

## 功能概述

为了防止告警记录和监控数据占用过多磁盘空间，系统提供了灵活的数据清除功能。

## 功能特性

### 1. 多种清除范围
- **清除所有告警记录**：删除所有历史告警
- **清除7天前的记录**：保留最近7天的告警
- **清除30天前的记录**：保留最近30天的告警
- **清除90天前的记录**：保留最近90天的告警
- **仅清除已处理的记录**：只删除状态为"已处理"的告警

### 2. 监控数据清除（可选）
可以选择同时清除对应时间范围的监控数据，释放更多空间。

### 3. 数据库优化
清除后自动执行 `VACUUM` 命令，回收磁盘空间。

### 4. 安全确认
需要输入 `DELETE` 确认删除，防止误操作。

## 使用方法

### 访问告警记录页面
1. 打开系统：http://localhost:8080
2. 点击左侧菜单"告警记录"
3. 查看页面顶部的统计信息：
   - 总告警数
   - 待处理数量
   - 已处理数量
   - 数据库大小

### 清除告警记录
1. 点击右上角"清除记录"按钮
2. 在弹出的对话框中：
   - 选择清除范围
   - 勾选是否同时清除监控数据（可选）
   - 输入 `DELETE` 确认
3. 点击"确认清除"按钮
4. 等待操作完成，页面会自动刷新

## 清除范围说明

### 清除所有告警记录
- **删除内容**：所有告警记录
- **保留内容**：无
- **适用场景**：系统重置、测试环境清理
- **风险**：⚠️ 高 - 所有历史告警将丢失

### 清除7天前的记录
- **删除内容**：7天前的告警记录
- **保留内容**：最近7天的告警
- **适用场景**：日常维护
- **风险**：✅ 低 - 保留近期重要告警

### 清除30天前的记录
- **删除内容**：30天前的告警记录
- **保留内容**：最近30天的告警
- **适用场景**：月度清理
- **风险**：✅ 低 - 保留一个月的历史

### 清除90天前的记录
- **删除内容**：90天前的告警记录
- **保留内容**：最近90天的告警
- **适用场景**：季度清理
- **风险**：✅ 低 - 保留三个月的历史

### 仅清除已处理的记录
- **删除内容**：状态为"已处理"的告警
- **保留内容**：待处理的告警
- **适用场景**：清理已解决的问题
- **风险**：✅ 低 - 保留未处理的告警

## 监控数据清除

### 什么是监控数据？
监控数据是系统定期采集的服务器、应用、数据库等的状态信息，存储在 `monitor_data` 表中。

### 是否需要清除监控数据？
- **需要**：如果数据库很大（>100MB），且不需要长期历史数据
- **不需要**：如果需要查看历史趋势图表

### 清除影响
- ✅ 释放更多磁盘空间
- ❌ 历史图表数据丢失
- ❌ 无法查看历史趋势

## 数据库大小管理

### 查看数据库大小
在告警记录页面右上角的统计卡片中显示。

### 数据库大小参考
- **< 10 MB**：正常，无需清理
- **10-50 MB**：建议定期清理（30天）
- **50-100 MB**：建议清理（7天）
- **> 100 MB**：建议立即清理，并清除监控数据

### 数据库优化
清除记录后，系统会自动执行 `VACUUM` 命令：
- 回收已删除记录占用的空间
- 重新组织数据库文件
- 提升查询性能

## API 接口

### 获取数据库大小
```http
GET /api/database-size
```

**响应示例**：
```json
{
  "size": "15.23 MB",
  "bytes": 15974400
}
```

### 清除告警记录
```http
POST /api/clear-alerts
Content-Type: application/json

{
  "range": "30days",
  "clear_monitor_data": true
}
```

**参数说明**：
- `range`: 清除范围（all, 7days, 30days, 90days, resolved）
- `clear_monitor_data`: 是否同时清除监控数据（true/false）

**响应示例**：
```json
{
  "success": true,
  "deleted_alerts": 150,
  "deleted_monitor_data": 5000
}
```

## 自动清理（计划功能）

### 配置自动清理策略
未来版本将支持自动清理策略：
- 自动清除N天前的记录
- 定时执行清理任务
- 保留最近N条记录

### 临时方案
可以使用 cron 定时任务：
```bash
# 每周日凌晨2点清除30天前的记录
0 2 * * 0 curl -X POST http://localhost:8080/api/clear-alerts \
  -H "Content-Type: application/json" \
  -d '{"range":"30days","clear_monitor_data":true}'
```

## 注意事项

### ⚠️ 重要提醒
1. **数据无法恢复**：删除的记录无法恢复，请谨慎操作
2. **备份建议**：清除前建议备份数据库文件
3. **业务影响**：清除期间可能影响系统性能
4. **权限控制**：建议只允许管理员执行清除操作

### 备份数据库
清除前建议备份：
```bash
cp monitoring.db monitoring.db.backup.$(date +%Y%m%d)
```

### 恢复数据库
如果误删除：
```bash
cp monitoring.db.backup.20260119 monitoring.db
```

## 故障排查

### 清除失败
**可能原因**：
- 数据库文件被锁定
- 磁盘空间不足
- 权限不足

**解决方法**：
1. 停止监控系统
2. 手动执行清理
3. 检查磁盘空间
4. 检查文件权限

### 数据库大小未减小
**原因**：SQLite 的 VACUUM 命令需要临时空间

**解决方法**：
1. 确保磁盘有足够空间（至少是数据库大小的2倍）
2. 手动执行 VACUUM：
```bash
sqlite3 monitoring.db "VACUUM;"
```

### 清除后系统变慢
**原因**：VACUUM 操作重建索引

**解决方法**：
- 等待几分钟，系统会自动恢复
- 重启系统

## 最佳实践

### 日常维护
- **每周**：清除已处理的告警
- **每月**：清除30天前的记录
- **每季度**：清除90天前的记录，并清除监控数据

### 生产环境
- 设置告警保留策略（建议30-90天）
- 定期备份数据库
- 监控数据库大小
- 在低峰期执行清理

### 测试环境
- 可以频繁清除所有记录
- 不需要保留历史数据
- 定期重置数据库

## 相关文档

- [使用说明.md](使用说明.md) - 系统使用指南
- [故障排查指南.md](故障排查指南.md) - 常见问题解决
- [监控配置指南.md](监控配置指南.md) - 监控配置说明

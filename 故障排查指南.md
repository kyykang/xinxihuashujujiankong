# 远程服务器连接故障排查指南

## 问题：编辑后显示远程服务器连接失败

### 已修复的问题
系统已修复编辑时密码丢失的问题：
- 编辑时如果密码字段留空，会自动保留原密码
- 后端会合并新旧配置，不会覆盖敏感信息

### 排查步骤

#### 1. 检查配置是否正确保存

访问浏览器开发者工具（F12），在编辑保存时查看 Network 标签：
- 找到 PUT 请求到 `/api/targets/{id}`
- 查看 Request Payload，确认配置数据是否正确

#### 2. 查看数据库中的配置

```bash
# 连接到数据库
sqlite3 monitoring.db

# 查看所有监控目标
SELECT id, name, type, config, enabled FROM monitor_targets;

# 查看特定目标的配置
SELECT config FROM monitor_targets WHERE id = 1;

# 退出
.quit
```

#### 3. 检查监控日志

查看服务器终端输出，看是否有 SSH 连接错误信息。

#### 4. 手动测试 SSH 连接

在监控系统服务器上测试 SSH 连接：

```bash
# 使用密码
ssh username@remote-server-ip

# 使用密钥
ssh -i /path/to/key username@remote-server-ip
```

#### 5. 常见问题检查清单

**网络连接问题：**
- [ ] 监控服务器能否 ping 通目标服务器
- [ ] 目标服务器的 SSH 端口是否开放
- [ ] 防火墙是否允许 SSH 连接

**认证问题：**
- [ ] 用户名是否正确
- [ ] 密码是否正确（编辑时如果修改了密码，确保输入正确）
- [ ] SSH 密钥文件路径是否正确
- [ ] SSH 密钥文件权限是否正确（应该是 600）

**配置问题：**
- [ ] IP 地址是否正确
- [ ] SSH 端口是否正确（默认 22）
- [ ] 监控目标状态是否为"启用"

### 调试技巧

#### 查看详细的监控数据

在浏览器中访问：
```
http://localhost:8080/api/monitor-data/{target_id}
```

查看最近的监控结果，包括错误信息。

#### 临时启用详细日志

修改 `remote_monitor.py`，在 `connect()` 方法中添加详细日志：

```python
def connect(self):
    """建立SSH连接"""
    try:
        print(f"尝试连接到 {self.host}:{self.port}")
        self.client = paramiko.SSHClient()
        self.client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        
        if self.key_file:
            print(f"使用密钥文件: {self.key_file}")
            self.client.connect(...)
        else:
            print(f"使用密码认证，用户名: {self.username}")
            self.client.connect(...)
        
        print("连接成功！")
        return True
    except Exception as e:
        print(f"SSH连接失败 [{self.host}]: {e}")
        return False
```

#### 测试单个监控目标

创建一个测试脚本 `test_remote.py`：

```python
from remote_monitor import RemoteServerMonitor

# 替换为你的实际配置
monitor = RemoteServerMonitor(
    host='192.168.1.100',
    port=22,
    username='root',
    password='your_password'
)

if monitor.connect():
    print("✓ 连接成功")
    
    cpu = monitor.check_cpu()
    print(f"CPU: {cpu}%")
    
    memory = monitor.check_memory()
    print(f"内存: {memory}%")
    
    disk = monitor.check_disk()
    print(f"磁盘: {disk}%")
    
    monitor.disconnect()
else:
    print("✗ 连接失败")
```

运行测试：
```bash
python3 test_remote.py
```

### 解决方案

#### 方案1：重新创建监控目标
如果编辑后仍有问题，可以：
1. 删除有问题的监控目标
2. 重新创建，确保所有配置正确

#### 方案2：直接修改数据库
如果确定是配置问题，可以直接修改数据库：

```bash
sqlite3 monitoring.db

# 查看当前配置
SELECT id, name, config FROM monitor_targets WHERE id = 1;

# 更新配置（替换为正确的 JSON）
UPDATE monitor_targets 
SET config = '{"is_remote": true, "host": "192.168.1.100", "port": 22, "username": "root", "password": "correct_password"}' 
WHERE id = 1;

.quit
```

#### 方案3：检查 SSH 密钥权限
如果使用 SSH 密钥认证：

```bash
# 检查密钥文件权限
ls -l /path/to/private_key

# 修改权限（如果需要）
chmod 600 /path/to/private_key

# 确保密钥文件所有者正确
chown your_user:your_group /path/to/private_key
```

### 预防措施

1. **测试后再保存**：添加或编辑监控目标后，立即查看监控数据确认工作正常

2. **备份配置**：定期备份数据库文件
   ```bash
   cp monitoring.db monitoring.db.backup
   ```

3. **使用 SSH 密钥**：相比密码认证，SSH 密钥更安全可靠

4. **记录配置**：在外部文档中记录重要的监控配置

### 获取帮助

如果以上方法都无法解决问题，请提供以下信息：

1. 监控目标的配置（隐藏敏感信息）
2. 服务器终端的错误日志
3. 浏览器控制台的错误信息
4. 手动 SSH 连接是否成功

---

**提示**：大多数连接问题都是由于网络、认证或配置错误引起的，仔细检查这些方面通常能解决问题。

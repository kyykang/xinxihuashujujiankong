# 检查间隔配置说明

## 问题描述

修改系统配置中的"检查间隔"后，系统仍然按照旧的间隔（60秒）执行监控任务。

## 原因分析

系统启动时，调度器使用的是 `config.py` 中的默认值（60秒），而不是数据库中保存的配置。

## 解决方案

### 1. 修改配置后重启系统

**步骤**：
1. 访问系统配置页面：http://localhost:8080/config
2. 修改"检查间隔（秒）"，例如改为600
3. 点击"保存配置"
4. 系统会提示：**"配置已保存，请重启系统使检查间隔生效"**
5. 停止当前运行的系统（在终端按 Ctrl+C）
6. 重新启动系统：`python3 app.py`
7. 查看启动日志，确认新的检查间隔

### 2. 验证配置是否生效

**启动日志**：
```
启动监控调度器，检查间隔: 600秒
 * Running on http://127.0.0.1:8080
```

**监控日志**：
```
监控任务完成: 2 成功, 0 失败, 耗时 1.80秒
（10分钟后）
监控任务完成: 2 成功, 0 失败, 耗时 1.85秒
```

## 检查间隔设置建议

### 根据监控目标数量

| 监控目标数量 | 建议间隔 | 说明 |
|------------|---------|------|
| 1-5个 | 60秒 | 快速响应，负载低 |
| 6-10个 | 120秒 | 平衡响应和负载 |
| 11-20个 | 300秒 | 减少系统负载 |
| 20个以上 | 600秒 | 避免系统过载 |

### 根据监控类型

| 监控类型 | 建议间隔 | 原因 |
|---------|---------|------|
| 服务器资源 | 60-120秒 | 资源变化较快 |
| 应用可用性 | 30-60秒 | 需要快速发现故障 |
| 数据库连接 | 60-120秒 | 连接状态相对稳定 |
| 业务指标 | 300-600秒 | 业务数据变化较慢 |
| 存储空间 | 600-3600秒 | 磁盘空间变化很慢 |

### 根据业务需求

**高优先级监控**（需要快速响应）：
- 生产环境关键服务：30-60秒
- 支付系统：30-60秒
- 核心业务API：60秒

**中优先级监控**（正常响应）：
- 一般业务系统：120-300秒
- 内部管理系统：300秒
- 数据统计：300-600秒

**低优先级监控**（定期检查）：
- 测试环境：600秒
- 开发环境：600-1800秒
- 存储空间：3600秒（1小时）

## 性能影响

### 检查间隔与系统负载

假设有10个监控目标，每个目标检查耗时2秒：

| 检查间隔 | 每小时检查次数 | 每小时总耗时 | CPU占用 |
|---------|--------------|------------|---------|
| 30秒 | 120次 | 40分钟 | 高 |
| 60秒 | 60次 | 20分钟 | 中 |
| 120秒 | 30次 | 10分钟 | 低 |
| 300秒 | 12次 | 4分钟 | 很低 |
| 600秒 | 6次 | 2分钟 | 极低 |

### 远程服务器监控的影响

如果有远程服务器监控（SSH连接）：
- 每次连接耗时：3-5秒
- 10个远程服务器：30-50秒
- 建议间隔：≥300秒

### 数据库查询的影响

如果有复杂的业务指标查询：
- 每次查询耗时：1-10秒
- 多个复杂查询：可能超过1分钟
- 建议间隔：≥600秒

## 配置示例

### 示例1：小型系统（5个监控目标）
```
检查间隔: 60秒
监控目标:
- 本地服务器资源
- 2个应用服务
- 1个数据库
- 1个业务指标

说明: 目标少，可以频繁检查
```

### 示例2：中型系统（15个监控目标）
```
检查间隔: 300秒
监控目标:
- 3个服务器（1本地+2远程）
- 5个应用服务
- 3个数据库
- 4个业务指标

说明: 目标较多，5分钟检查一次合适
```

### 示例3：大型系统（30个监控目标）
```
检查间隔: 600秒
监控目标:
- 10个远程服务器
- 10个应用服务
- 5个数据库
- 5个业务指标

说明: 目标很多，10分钟检查一次避免过载
```

## 动态调整策略

### 白天和夜间不同间隔（未来功能）

```python
# 白天（9:00-18:00）：频繁检查
check_interval = 60秒

# 夜间（18:00-9:00）：降低频率
check_interval = 300秒
```

### 根据告警频率调整（未来功能）

```python
# 如果频繁告警：增加检查频率
if alert_count > 10:
    check_interval = 30秒

# 如果长期正常：降低检查频率
if no_alert_for_24h:
    check_interval = 600秒
```

## 常见问题

### Q1: 修改配置后为什么不立即生效？

**A**: 调度器在系统启动时初始化，修改配置后需要重启系统才能生效。

### Q2: 可以不重启系统就生效吗？

**A**: 目前不支持。未来版本可能会添加热重载功能。

### Q3: 检查间隔最小可以设置多少？

**A**: 理论上可以设置为1秒，但不推荐：
- 会导致系统负载过高
- 可能导致监控任务重叠
- 建议最小30秒

### Q4: 检查间隔最大可以设置多少？

**A**: 没有限制，但建议：
- 最大3600秒（1小时）
- 太长会导致问题发现不及时
- 根据业务需求合理设置

### Q5: 如何知道当前的检查间隔？

**A**: 查看系统启动日志：
```
启动监控调度器，检查间隔: 600秒
```

### Q6: 不同监控目标可以设置不同间隔吗？

**A**: 目前不支持，所有监控目标使用相同的检查间隔。未来版本可能会支持。

## 最佳实践

### 1. 初期设置
- 开始时使用较短间隔（60秒）
- 观察系统负载和告警频率
- 根据实际情况调整

### 2. 定期review
- 每月检查一次配置
- 根据监控目标数量调整
- 根据系统负载调整

### 3. 分类监控
- 关键服务：短间隔（60秒）
- 一般服务：中间隔（300秒）
- 辅助监控：长间隔（600秒）

### 4. 性能优化
- 优化SQL查询速度
- 使用索引加速查询
- 减少不必要的监控目标

## 故障排查

### 问题：修改后还是60秒

**检查步骤**：
1. 确认配置已保存到数据库
   ```bash
   sqlite3 monitoring.db "SELECT * FROM system_config WHERE key='check_interval'"
   ```

2. 确认已重启系统

3. 查看启动日志中的检查间隔

4. 观察监控任务执行时间间隔

### 问题：系统负载过高

**解决方法**：
1. 增加检查间隔
2. 减少监控目标
3. 优化SQL查询
4. 使用更强的服务器

### 问题：告警不及时

**解决方法**：
1. 减少检查间隔
2. 使用存在模式（阈值=0）
3. 优化告警阈值
4. 考虑增加监控目标

## 总结

- ✅ 修改检查间隔后必须重启系统
- ✅ 根据监控目标数量合理设置
- ✅ 平衡响应速度和系统负载
- ✅ 定期review和调整配置
- ✅ 关注系统启动日志确认生效

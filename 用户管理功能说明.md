# 用户管理功能说明

## 功能概述

系统现已支持多用户管理和基于角色的权限控制，可以为不同的用户分配不同的访问权限。

## 快速开始

### 1. 使用默认管理员登录

访问 http://localhost:8080，使用以下账户登录：
- 用户名: `admin`
- 密码: `admin123`

### 2. 添加只读用户

#### 方法A：使用Web界面（推荐）

1. 登录后，点击左侧菜单的"用户管理"
2. 点击右上角"添加用户"按钮
3. 填写信息：
   - 用户名：例如 `viewer`
   - 邮箱：可选
   - 密码：至少6位
   - 管理员权限：**不勾选**（普通用户只能查看）
4. 点击"保存"

#### 方法B：使用命令行脚本

```bash
# 添加普通用户（只读权限）
python3 add_user.py viewer viewer123 "viewer@example.com" 0

# 交互式添加
python3 add_user.py
```

### 3. 测试只读权限

1. 退出管理员账户
2. 使用新创建的普通用户登录
3. 你会发现：
   - ✅ 可以查看监控仪表板
   - ✅ 可以查看监控目标列表
   - ✅ 可以查看告警记录
   - ❌ 看不到"添加监控目标"按钮
   - ❌ 看不到"编辑"和"删除"按钮
   - ❌ 看不到"用户管理"菜单
   - ❌ 系统配置页面的输入框被禁用

## 用户角色对比

| 功能 | 管理员 | 普通用户 |
|------|--------|----------|
| 查看监控仪表板 | ✅ | ✅ |
| 查看监控目标 | ✅ | ✅ |
| 添加监控目标 | ✅ | ❌ |
| 编辑监控目标 | ✅ | ❌ |
| 删除监控目标 | ✅ | ❌ |
| 查看告警记录 | ✅ | ✅ |
| 清除告警记录 | ✅ | ❌ |
| 查看系统配置 | ✅ | ✅ |
| 修改系统配置 | ✅ | ❌ |
| 用户管理 | ✅ | ❌ |
| 修改自己密码 | ✅ | ✅ |

## 用户管理操作

### 查看用户列表

1. 使用管理员账户登录
2. 点击左侧菜单"用户管理"
3. 可以看到所有用户的信息：
   - 用户名
   - 邮箱
   - 角色（管理员/普通用户）
   - 创建时间
   - 最后登录时间

### 编辑用户

1. 在用户列表中找到要编辑的用户
2. 点击"编辑"按钮
3. 可以修改：
   - 用户名
   - 邮箱
   - 密码（留空则不修改）
   - 管理员权限
4. 点击"保存"

### 删除用户

1. 在用户列表中找到要删除的用户
2. 点击"删除"按钮
3. 确认删除

⚠️ **注意**：不能删除当前登录的用户

### 修改密码

所有用户都可以修改自己的密码：

1. 点击右上角的设置图标（齿轮）
2. 选择"修改密码"
3. 输入原密码
4. 输入新密码（至少6位）
5. 确认新密码
6. 点击"修改密码"
7. 系统会自动退出，使用新密码重新登录

## 使用场景

### 场景1：运维团队协作

**需求**：运维团队有5个人，只有主管需要配置监控，其他人只需要查看。

**方案**：
- 主管使用管理员账户（admin）
- 为其他4个人创建普通用户账户
- 普通用户可以查看所有监控数据，但不能修改配置

### 场景2：跨部门监控

**需求**：IT部门管理监控系统，业务部门需要查看相关指标。

**方案**：
- IT部门使用管理员账户
- 为业务部门创建普通用户账户
- 业务部门可以查看监控数据，但不能修改

### 场景3：大屏展示

**需求**：在办公区域的大屏上展示监控仪表板。

**方案**：
- 创建一个专门的只读账户（如 `display`）
- 大屏使用该账户登录
- 只展示监控数据，不显示任何操作按钮

### 场景4：临时访问

**需求**：外部审计人员需要临时查看监控数据。

**方案**：
- 创建临时普通用户账户
- 审计结束后删除该账户

## 安全建议

### 1. 密码策略
- 使用至少8位包含字母、数字和特殊字符的密码
- 定期更换密码（建议每3个月）
- 不要使用简单密码（如123456、password等）

### 2. 账户管理
- 遵循最小权限原则，只给需要的人分配管理员权限
- 定期审查用户列表，删除不再使用的账户
- 员工离职时立即删除其账户

### 3. 默认账户
- 首次登录后立即修改默认管理员密码
- 考虑创建新的管理员账户后删除默认账户

### 4. 会话管理
- 使用"记住我"功能时要注意设备安全
- 在公共设备上使用后记得退出登录

## 技术实现

### 权限控制层级

1. **前端控制**：根据用户角色隐藏/禁用按钮和表单
2. **后端验证**：API层面验证用户权限，防止绕过前端限制
3. **装饰器**：使用 `@login_required` 和 `@admin_required` 保护路由

### 密码安全

- 使用 PBKDF2-SHA256 哈希算法存储密码
- 密码不以明文形式存储
- 密码哈希包含随机盐值

### 会话管理

- 使用 Flask Session 管理用户登录状态
- 支持"记住我"功能（最长30天）
- 会话数据加密存储

## 常见问题

### Q1: 如何重置管理员密码？

如果忘记管理员密码，可以使用以下脚本重置：

```python
# reset_password.py
import sqlite3
from werkzeug.security import generate_password_hash

conn = sqlite3.connect('monitoring.db')
cursor = conn.cursor()

# 重置admin用户的密码为 admin123
new_password_hash = generate_password_hash('admin123', method='pbkdf2:sha256')
cursor.execute('UPDATE users SET password_hash = ? WHERE username = ?', 
               (new_password_hash, 'admin'))
conn.commit()
conn.close()

print('管理员密码已重置为: admin123')
```

运行：
```bash
python3 reset_password.py
```

### Q2: 普通用户能看到其他用户的信息吗？

不能。普通用户无法访问用户管理页面，也无法调用用户管理相关的API。

### Q3: 可以设置更细粒度的权限吗？

当前版本只支持管理员和普通用户两种角色。如需更细粒度的权限控制（如只能管理特定类型的监控目标），需要扩展权限系统。

### Q4: 如何批量导入用户？

可以编写脚本批量创建用户：

```python
import sqlite3
from werkzeug.security import generate_password_hash

users = [
    ('user1', 'password1', 'user1@example.com', 0),
    ('user2', 'password2', 'user2@example.com', 0),
    # ... 更多用户
]

conn = sqlite3.connect('monitoring.db')
cursor = conn.cursor()

for username, password, email, is_admin in users:
    password_hash = generate_password_hash(password, method='pbkdf2:sha256')
    try:
        cursor.execute('''
            INSERT INTO users (username, password_hash, email, is_admin)
            VALUES (?, ?, ?, ?)
        ''', (username, password_hash, email, is_admin))
        print(f'✓ 添加用户: {username}')
    except:
        print(f'✗ 用户已存在: {username}')

conn.commit()
conn.close()
```

### Q5: 用户数据存储在哪里？

用户数据存储在 SQLite 数据库的 `users` 表中：
- 位置：`monitoring.db`
- 表名：`users`
- 字段：id, username, password_hash, email, is_admin, created_at, last_login

## 相关文档

- [用户权限管理说明.md](用户权限管理说明.md) - 详细的权限说明
- [用户认证说明.md](用户认证说明.md) - 认证系统技术文档
- [安全配置说明.md](安全配置说明.md) - 密码加密和安全配置

## 更新日志

### v2.0 (2026-01-21)
- ✅ 添加用户认证功能
- ✅ 添加用户管理界面
- ✅ 实现基于角色的权限控制
- ✅ 添加只读用户支持
- ✅ 添加命令行用户管理脚本
- ✅ 更新文档和使用说明
